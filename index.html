<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ìƒí™œ ê°€ê³„ë¶€">
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>ìƒí™œ ê°€ê³„ë¶€</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }

    :root {
      --primary: #6C5DD3;
      --primary-dark: #5847C4;
      --primary-light: #8F7EEB;
      --success: #00C9A7;
      --danger: #FF6B6B;
      --warning: #FFB84D;
      --gray-50: #F3F4F6;
      --gray-100: #E8EBF0;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 14px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: var(--gray-50);
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      color: var(--gray-900);
      line-height: 1.5;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      background: var(--gray-50);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: calc(70px + env(safe-area-inset-bottom));
    }

    /* í—¤ë” */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: max(24px, env(safe-area-inset-top)) 20px 20px;
      box-shadow: var(--shadow-md);
    }

    /* ë‹¬ë ¥ íƒ­ì´ ì•„ë‹ ë•Œ í—¤ë” ìˆ¨ê¸°ê¸° */
    body:not([data-active-tab="calendar"]) .header {
      display: none;
    }

    /* íƒ­ ì œëª© */
    .tab-title {
      background: white;
      padding: max(20px, env(safe-area-inset-top)) 16px 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .tab-title h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--gray-900);
      margin: 0;
      letter-spacing: -0.5px;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 700;
      color: white;
      margin-bottom: 16px;
      letter-spacing: -0.5px;
    }

    .month-selector {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .month-selector button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .month-selector button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .month-selector button:active {
      background: rgba(255, 255, 255, 0.4);
      transform: scale(0.95);
    }

    .month-selector span {
      font-size: 18px;
      font-weight: 700;
      color: white;
    }

    /* ìš”ì•½ ì¹´ë“œ */
    .summary {
      background: white;
      margin: 0;
      padding: 16px 20px;
      box-shadow: var(--shadow-sm);
      border-bottom: 1px solid var(--gray-100);
    }

    .summary-row {
      display: flex;
      justify-content: space-around;
      align-items: center;
      gap: 12px;
    }

    .summary-item {
      text-align: center;
      flex: 1;
      padding: 8px 0;
    }

    .summary-label {
      color: var(--gray-500);
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .summary-value {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .summary-value.income {
      color: var(--success);
    }

    .summary-value.expense {
      color: var(--danger);
    }

    .summary-value.balance {
      color: var(--primary);
    }

    /* ì½˜í…ì¸  ì˜ì—­ */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }

    /* ë‹¬ë ¥ íƒ­ ì œì™¸í•œ íƒ­ë“¤ì˜ íŒ¨ë”© */
    #log-content,
    #assets-content,
    #stats-content,
    #settings-content {
      padding: 16px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      transition: all 0.2s ease;
      border: 1px solid var(--gray-100);
    }

    .card:hover {
      box-shadow: var(--shadow-md);
    }

    /* ë‹¬ë ¥ */
    .calendar {
      background: white;
      border-radius: 0;
      padding: 20px 12px;
      margin-bottom: 0;
      box-shadow: var(--shadow-sm);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }

    .calendar-day-header {
      text-align: center;
      padding: 12px 0 10px;
      font-size: 11px;
      color: var(--gray-400);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .calendar-day-header.sun {
      color: #FF6B6B;
    }

    .calendar-day-header.sat {
      color: #6C5DD3;
    }

    .calendar-day {
      aspect-ratio: 1;
      border-radius: 10px;
      padding: 8px 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
      background: transparent;
    }

    .calendar-day:hover {
      background: var(--gray-100);
      transform: scale(1.05);
    }

    .calendar-day:active {
      transform: scale(0.95);
    }

    .calendar-day.other-month {
      opacity: 0.25;
    }

    .calendar-day.today {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      box-shadow: var(--shadow);
    }

    /* ë‹¤ë¥¸ ë‚ ì§œê°€ ì„ íƒë˜ì—ˆì„ ë•Œ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ì—°í•˜ê²Œ */
    body[data-has-selected="true"] .calendar-day.today:not(.selected) {
      opacity: 0.4;
    }

    .calendar-day.selected {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .calendar-day.today .calendar-day-number,
    .calendar-day.selected .calendar-day-number {
      color: white;
    }

    .calendar-day.today .calendar-day-income,
    .calendar-day.selected .calendar-day-income {
      color: white;
      opacity: 0.95;
    }

    .calendar-day.today .calendar-day-expense,
    .calendar-day.selected .calendar-day-expense {
      color: white;
      opacity: 0.95;
    }

    .calendar-day-number {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 3px;
      color: var(--gray-900);
    }

    .calendar-day.sun .calendar-day-number {
      color: #FF6B6B;
    }

    .calendar-day.sat .calendar-day-number {
      color: #6C5DD3;
    }

    .calendar-day-income {
      font-size: 9px;
      font-weight: 700;
      color: var(--success);
      white-space: nowrap;
    }

    .calendar-day-expense {
      font-size: 9px;
      font-weight: 700;
      color: var(--danger);
      white-space: nowrap;
    }

    /* ë‹¬ë ¥ í•˜ë‹¨ ì„ íƒëœ ë‚ ì§œì˜ ê±°ë˜ ë‚´ì—­ */
    .calendar-selected-transactions {
      background: white;
      border-radius: 0;
      padding: 20px 16px;
      margin-bottom: 0;
      margin-top: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      min-height: 100px;
    }

    .calendar-selected-date {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 12px;
    }

    .calendar-transaction-list {
      max-height: 300px;
      overflow-y: auto;
    }

    /* ê±°ë˜ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ */
    .transaction-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .transaction-item {
      background: white;
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-100);
    }

    .transaction-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .transaction-item:active {
      transform: translateY(0) scale(0.98);
    }

    .transaction-left {
      flex: 1;
    }

    .transaction-date-badge {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      background: var(--gray-100);
      color: var(--gray-600);
      padding: 3px 8px;
      border-radius: 4px;
      margin-right: 6px;
    }

    .transaction-user {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      background: var(--gray-100);
      color: var(--gray-700);
      padding: 3px 8px;
      border-radius: 4px;
      margin-right: 6px;
    }

    .transaction-category {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-900);
      letter-spacing: -0.3px;
      margin-top: 6px;
    }

    .transaction-method {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 3px;
      font-weight: 500;
    }

    .transaction-amount {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .transaction-amount.income {
      color: var(--success);
    }

    .transaction-amount.expense {
      color: var(--gray-900);
    }

    .transaction-amount.transfer {
      color: var(--warning);
    }

    /* ìì‚° ì¹´ë“œ - ìƒˆë¡œìš´ ë””ìì¸ */
    .asset-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-100);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .asset-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .asset-card:active {
      transform: translateY(0) scale(0.98);
    }

    .asset-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .asset-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-600);
    }

    .asset-balance {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
      letter-spacing: -0.5px;
    }

    .asset-budget-bar {
      height: 8px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .budget-progress {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 0.3s ease, background 0.3s ease;
    }

    .budget-progress.warning {
      background: var(--warning);
    }

    .budget-progress.danger {
      background: var(--danger);
    }

    .asset-budget-info {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--gray-500);
      font-weight: 500;
    }

    /* ì°¨íŠ¸ */
    .chart {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-100);
    }

    .chart-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--gray-900);
      letter-spacing: -0.3px;
    }

    .chart-canvas {
      width: 100%;
      height: 250px !important;
      max-height: 250px !important;
    }

    .bar-chart {
      margin-bottom: 0;
    }

    .bar-item {
      margin-bottom: 16px;
    }

    .bar-item:last-child {
      margin-bottom: 0;
    }

    .bar-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .bar-label span:first-child {
      font-weight: 600;
      color: var(--gray-700);
    }

    .bar-label span:last-child {
      font-weight: 700;
      color: var(--gray-900);
    }

    .bar-bg {
      height: 8px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .bar-fill.warning {
      background: var(--warning);
    }

    .bar-fill.danger {
      background: var(--danger);
    }

    /* ê²€ìƒ‰ë°” */
    .search-bar {
      margin-bottom: 16px;
    }

    .search-input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid var(--gray-100);
      border-radius: 14px;
      font-size: 14px;
      background: white;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
    }

    .search-input::placeholder {
      color: var(--gray-400);
    }

    /* í•„í„° ë²„íŠ¼ ê·¸ë£¹ */
    .filter-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .filter-btn {
      padding: 10px 18px;
      background: white;
      border: 2px solid var(--gray-100);
      border-radius: 24px;
      font-size: 13px;
      font-weight: 700;
      white-space: nowrap;
      cursor: pointer;
      color: var(--gray-600);
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .filter-btn:hover {
      border-color: var(--primary-light);
      color: var(--primary);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }

    /* í•˜ë‹¨ íƒ­ë°” */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--gray-100);
      display: flex;
      padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
      z-index: 100;
      max-width: 480px;
      margin: 0 auto;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 0;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--gray-400);
      transition: all 0.2s ease;
      position: relative;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 32px;
      height: 3px;
      background: var(--primary);
      border-radius: 0 0 3px 3px;
    }

    .nav-icon {
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
    }

    .nav-item.active .nav-icon {
      transform: scale(1.1);
    }

    .nav-icon svg {
      width: 24px;
      height: 24px;
    }

    .nav-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    /* í”Œë¡œíŒ… ë²„íŠ¼ */
    .fab {
      position: fixed;
      bottom: calc(85px + env(safe-area-inset-bottom));
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      font-size: 28px;
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      z-index: 99;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fab:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(108, 93, 211, 0.4);
    }

    .fab:active {
      transform: scale(0.95);
    }

    /* ëª¨ë‹¬ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
      animation: fadeIn 0.2s;
      overflow-x: hidden;
      overscroll-behavior-x: none;
    }

    .modal-overlay.active {
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal {
      background: white;
      border-radius: 20px 20px 0 0;
      padding: 24px 20px calc(24px + env(safe-area-inset-bottom));
      max-width: 480px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      overflow-x: hidden;
      overscroll-behavior-x: none;
      touch-action: pan-y;
      animation: slideUp 0.3s;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--gray-400);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* í¼ ìš”ì†Œ */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--gray-700);
      font-weight: 600;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      font-size: 14px;
      background: white;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* ê¸ˆì•¡ ì…ë ¥ */
    .amount-input-wrapper {
      position: relative;
      display: flex;
      gap: 8px;
    }

    .amount-input-wrapper .form-input {
      flex: 1;
    }

    .reset-amount-btn {
      padding: 12px 16px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .reset-amount-btn:active {
      background: var(--gray-200);
    }

    .quick-amount-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .quick-amount-btn {
      padding: 10px;
      background: var(--gray-100);
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-amount-btn:active {
      background: var(--gray-200);
      transform: scale(0.95);
    }

    /* ì„ íƒ ê·¸ë¦¬ë“œ */
    .select-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .select-item {
      padding: 12px;
      background: var(--gray-100);
      border: 1.5px solid var(--gray-200);
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      transition: all 0.2s;
    }

    .select-item:active {
      transform: scale(0.95);
    }

    .select-item.selected {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .expand-toggle {
      grid-column: 1 / -1;
      padding: 12px;
      background: none;
      border: none;
      color: var(--primary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
    }

    /* ë²„íŠ¼ */
    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    .btn-primary:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .btn-primary:active {
      transform: translateY(0) scale(0.98);
    }

    .btn-secondary {
      background: white;
      color: var(--gray-700);
      border: 2px solid var(--gray-200);
      box-shadow: none;
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-secondary:active {
      background: var(--gray-50);
      transform: scale(0.98);
    }

    /* ì„¤ì • í˜ì´ì§€ - ê°œì„ ëœ UI */
    .settings-section {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-100);
    }

    .settings-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 18px;
      color: var(--gray-900);
      letter-spacing: -0.3px;
    }

    .settings-item-card {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      background: var(--gray-50);
      border-radius: 12px;
      margin-bottom: 8px;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .settings-item-card:hover {
      background: white;
      border-color: var(--gray-200);
    }

    .settings-item-card:last-child {
      margin-bottom: 0;
    }

    .item-content {
      flex: 1;
    }

    .item-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 3px;
    }

    .item-meta {
      font-size: 12px;
      color: var(--gray-500);
      font-weight: 500;
    }

    .item-actions {
      display: flex;
      gap: 6px;
    }

    .icon-btn {
      background: white;
      border: 1.5px solid var(--gray-200);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 8px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      color: var(--gray-600);
      white-space: nowrap;
    }

    .icon-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }

    .icon-btn:active {
      transform: scale(0.95);
    }

    .icon-btn.favorite {
      color: var(--warning);
      border-color: var(--warning);
      background: rgba(255, 184, 77, 0.1);
    }

    .icon-btn.favorite:hover {
      background: rgba(255, 184, 77, 0.2);
    }

    .icon-btn.reorder {
      color: var(--gray-600);
      border-color: var(--gray-300);
      background: white;
      font-size: 14px;
      padding: 4px 8px;
    }

    .icon-btn.reorder:hover {
      background: var(--gray-50);
      color: var(--primary);
      border-color: var(--primary);
    }

    .icon-btn.edit {
      color: var(--primary);
      border-color: var(--primary);
      background: rgba(108, 93, 211, 0.05);
    }

    .icon-btn.edit:hover {
      background: rgba(108, 93, 211, 0.1);
    }

    .icon-btn.delete {
      color: var(--danger);
      border-color: var(--danger);
      background: rgba(255, 107, 107, 0.05);
    }

    .icon-btn.delete:hover {
      background: rgba(255, 107, 107, 0.1);
    }

    /* ìì‚° ì´ë™ */
    .transfer-arrow {
      text-align: center;
      font-size: 24px;
      color: var(--gray-400);
      margin: 16px 0;
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-400);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 14px;
      font-weight: 500;
    }

    /* ë™ê¸°í™” ë²„íŠ¼ */
    .sync-button {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      width: 100%;
      font-size: 15px;
      font-weight: 700;
      color: white;
    }

    .sync-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .sync-button:active {
      transform: translateY(0) scale(0.98);
    }

    .sync-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body data-active-tab="calendar">
  <div class="container">
    <!-- í—¤ë” -->
    <div class="header">
      <h1>ìƒí™œ ê°€ê³„ë¶€</h1>
      <div class="month-selector">
        <button id="prevMonth">â—€</button>
        <span id="currentMonth"></span>
        <button id="nextMonth">â–¶</button>
      </div>
    </div>

    <!-- ìš”ì•½ -->
    <div class="summary">
      <div class="summary-row">
        <div class="summary-item">
          <div class="summary-label">ìˆ˜ì…</div>
          <div class="summary-value income" id="totalIncome">0ì›</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">ì§€ì¶œ</div>
          <div class="summary-value expense" id="totalExpense">0ì›</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">ì”ì•¡</div>
          <div class="summary-value balance" id="totalBalance">0ì›</div>
        </div>
      </div>
    </div>

    <!-- ì½˜í…ì¸  -->
    <div class="content">
      <!-- ë‹¬ë ¥ íƒ­ -->
      <div class="tab-content active" id="calendar-content">
        <!-- ë‹¬ë ¥ -->
        <div class="calendar">
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <!-- ì„ íƒëœ ë‚ ì§œì˜ ê±°ë˜ ë‚´ì—­ -->
        <div class="calendar-selected-transactions" id="calendarSelectedTransactions">
          <div class="calendar-selected-date" id="calendarSelectedDate">ì˜¤ëŠ˜</div>
          <div class="calendar-transaction-list" id="calendarTransactionList">
            <div class="empty-state">
              <div class="empty-state-text">ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ê±°ë˜ ë‚´ì—­ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ë‚´ì—­ íƒ­ -->
      <div class="tab-content" id="log-content">
        <div class="tab-title">
          <h2>ë‚´ì—­</h2>
        </div>
        <div class="search-bar">
          <input type="text" class="search-input" id="searchInput" placeholder="ê±°ë˜ ë‚´ì—­ ê²€ìƒ‰">
        </div>
        <div class="filter-buttons" id="logFilters">
          <button class="filter-btn active" data-filter="all">ì „ì²´</button>
          <button class="filter-btn" data-filter="income">ìˆ˜ì…</button>
          <button class="filter-btn" data-filter="expense">ì§€ì¶œ</button>
          <button class="filter-btn" data-filter="transfer">ìì‚°ì´ë™</button>
        </div>
        <div class="transaction-list" id="transactionList"></div>
      </div>

      <!-- ìì‚° íƒ­ -->
      <div class="tab-content" id="assets-content">
        <div class="tab-title">
          <h2>ìì‚°</h2>
        </div>
        <div id="assetsList"></div>
        <button class="btn btn-secondary" id="transferAssetBtn">ìì‚° ì´ë™</button>
        <button class="btn btn-secondary" id="setBudgetBtn">ì˜ˆì‚° ì„¤ì •</button>
      </div>

      <!-- í†µê³„ íƒ­ -->
      <div class="tab-content" id="stats-content">
        <div class="tab-title">
          <h2>í†µê³„</h2>
        </div>
        <div class="filter-buttons">
          <button class="filter-btn active" data-period="week">ì£¼ê°„</button>
          <button class="filter-btn" data-period="month">ì›”ê°„</button>
          <button class="filter-btn" data-period="year">ì—°ê°„</button>
        </div>

        <!-- ë¼ì¸ ì°¨íŠ¸ -->
        <div class="chart">
          <div class="chart-title">íŠ¸ë Œë“œ</div>
          <canvas id="trendChart" class="chart-canvas"></canvas>
        </div>

        <div id="statsCharts"></div>
      </div>

      <!-- ì„¤ì • íƒ­ -->
      <div class="tab-content" id="settings-content">
        <div class="tab-title">
          <h2>ì„¤ì •</h2>
        </div>
        <!-- ìˆ˜ë™ ë™ê¸°í™” ë²„íŠ¼ -->
        <button class="sync-button" id="syncData">
          <span>ğŸ”„</span>
          <span>ìˆ˜ë™ ë™ê¸°í™”</span>
        </button>

        <div class="settings-section">
          <div class="settings-title">ê²°ì œìˆ˜ë‹¨ ê´€ë¦¬</div>
          <div id="paymentMethodsList"></div>
          <button class="btn btn-secondary" id="addPaymentMethod">+ ê²°ì œìˆ˜ë‹¨ ì¶”ê°€</button>
        </div>

        <div class="settings-section">
          <div class="settings-title">ìì‚° ê´€ë¦¬</div>
          <div id="assetsSettingsList"></div>
          <button class="btn btn-secondary" id="addAsset">+ ìì‚° ì¶”ê°€</button>
        </div>

        <div class="settings-section">
          <div class="settings-title">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</div>
          <div id="categoriesList"></div>
          <button class="btn btn-secondary" id="addCategory">+ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
        </div>
      </div>
    </div>

    <!-- í•˜ë‹¨ íƒ­ë°” -->
    <nav class="bottom-nav">
      <button class="nav-item active" data-tab="calendar">
        <div class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </div>
        <div class="nav-label">ë‹¬ë ¥</div>
      </button>
      <button class="nav-item" data-tab="log">
        <div class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
        </div>
        <div class="nav-label">ë‚´ì—­</div>
      </button>
      <button class="nav-item" data-tab="assets">
        <div class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
        </div>
        <div class="nav-label">ìì‚°</div>
      </button>
      <button class="nav-item" data-tab="stats">
        <div class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
          </svg>
        </div>
        <div class="nav-label">í†µê³„</div>
      </button>
      <button class="nav-item" data-tab="settings">
        <div class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6"></path>
          </svg>
        </div>
        <div class="nav-label">ì„¤ì •</div>
      </button>
    </nav>

    <!-- í”Œë¡œíŒ… ë²„íŠ¼ -->
    <button class="fab" id="addTransactionBtn">+</button>
  </div>

  <!-- ê±°ë˜ ì¶”ê°€ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="transactionModal">
    <div class="modal" id="transactionModalContent">
      <div class="modal-header">
        <h2 class="modal-title">ê±°ë˜ ì¶”ê°€</h2>
        <button class="modal-close" onclick="closeModal('transactionModal')">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label">ì‚¬ìš©ì</label>
        <div class="select-grid" id="userSelect"></div>
      </div>

      <div class="form-group">
        <label class="form-label">ìœ í˜•</label>
        <div class="select-grid">
          <div class="select-item selected" data-type="expense">ì§€ì¶œ</div>
          <div class="select-item" data-type="income">ìˆ˜ì…</div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ê¸ˆì•¡</label>
        <div class="amount-input-wrapper">
          <input type="text" inputmode="numeric" class="form-input" id="amountInput" placeholder="ê¸ˆì•¡ ì…ë ¥">
          <button class="reset-amount-btn" id="resetAmountBtn">ì´ˆê¸°í™”</button>
        </div>
        <div class="quick-amount-buttons">
          <button class="quick-amount-btn" data-amount="100000">+10ë§Œ</button>
          <button class="quick-amount-btn" data-amount="10000">+1ë§Œ</button>
          <button class="quick-amount-btn" data-amount="1000">+1ì²œ</button>
          <button class="quick-amount-btn" data-amount="100">+1ë°±</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
        <div class="select-grid" id="categorySelect"></div>
      </div>

      <div class="form-group">
        <label class="form-label">ê²°ì œìˆ˜ë‹¨</label>
        <div class="select-grid" id="paymentMethodSelect"></div>
      </div>

      <div class="form-group">
        <label class="form-label">ìì‚°</label>
        <div class="select-grid" id="assetSelect"></div>
      </div>

      <div class="form-group">
        <label class="form-label">ë‚ ì§œ</label>
        <input type="date" class="form-input" id="dateInput">
      </div>

      <div class="form-group">
        <label class="form-label">ë©”ëª¨ (ì„ íƒ)</label>
        <input type="text" class="form-input" id="memoInput" placeholder="ë©”ëª¨">
      </div>

      <button class="btn btn-primary" id="saveTransaction">ì €ì¥</button>
    </div>
  </div>

  <!-- ìì‚° ì´ë™ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="transferModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ìì‚° ì´ë™</h2>
        <button class="modal-close" onclick="closeModal('transferModal')">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label">ì¶œë°œ ìì‚°</label>
        <div class="select-grid" id="fromAssetSelect"></div>
      </div>

      <div class="transfer-arrow">â†“</div>

      <div class="form-group">
        <label class="form-label">ë„ì°© ìì‚°</label>
        <div class="select-grid" id="toAssetSelect"></div>
      </div>

      <div class="form-group">
        <label class="form-label">ê¸ˆì•¡</label>
        <div class="amount-input-wrapper">
          <input type="text" inputmode="numeric" class="form-input" id="transferAmountInput" placeholder="ì´ë™í•  ê¸ˆì•¡">
          <button class="reset-amount-btn" id="resetTransferAmountBtn">ì´ˆê¸°í™”</button>
        </div>
        <div class="quick-amount-buttons">
          <button class="quick-amount-btn" data-target="transfer" data-amount="100000">+10ë§Œ</button>
          <button class="quick-amount-btn" data-target="transfer" data-amount="10000">+1ë§Œ</button>
          <button class="quick-amount-btn" data-target="transfer" data-amount="1000">+1ì²œ</button>
          <button class="quick-amount-btn" data-target="transfer" data-amount="100">+1ë°±</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ë‚ ì§œ</label>
        <input type="date" class="form-input" id="transferDateInput">
      </div>

      <button class="btn btn-primary" id="saveTransfer">ì´ë™í•˜ê¸°</button>
    </div>
  </div>

  <!-- ìì‚° ë‚´ì—­ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="assetTransactionsModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="assetModalTitle">ìì‚° ë‚´ì—­</h2>
        <button class="modal-close" onclick="closeModal('assetTransactionsModal')">&times;</button>
      </div>
      <div class="transaction-list" id="assetTransactionsList"></div>
    </div>
  </div>

  <!-- ì˜ˆì‚° ì„¤ì • ëª¨ë‹¬ -->
  <div class="modal-overlay" id="budgetModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="budgetModalTitle">ì˜ˆì‚° ì„¤ì •</h2>
        <button class="modal-close" onclick="closeModal('budgetModal')">&times;</button>
      </div>
      <div id="budgetFormContent"></div>
    </div>
  </div>

  <script>
    // ============================================
    // ì „ì—­ ìƒíƒœ
    // ============================================
    let state = {
      currentDate: new Date(),
      selectedDate: formatDate(new Date()),
      selectedUser: null,
      selectedType: 'expense',
      selectedCategory: null,
      selectedPaymentMethod: null,
      selectedAsset: null,
      selectedFromAsset: null,
      selectedToAsset: null,
      logFilter: 'all',

      users: [
        { id: '1', name: 'êµ­í™˜' },
        { id: '2', name: 'í˜œì§€' }
      ],

      paymentMethods: [
        { id: '1', name: 'í˜„ê¸ˆ', displayOrder: 1, isFavorite: true },
        { id: '2', name: 'ì²´í¬ì¹´ë“œ', displayOrder: 2, isFavorite: true },
        { id: '3', name: 'ì‹ ìš©ì¹´ë“œ1', displayOrder: 3, isFavorite: true },
        { id: '4', name: 'ì‹ ìš©ì¹´ë“œ2', displayOrder: 4, isFavorite: true }
      ],

      assets: [
        { id: '1', name: 'ì…ì¶œê¸ˆ í†µì¥', balance: 0, displayOrder: 1, isFavorite: true, budget: 0 },
        { id: '2', name: 'ìë™ì°¨ í†µì¥', balance: 0, displayOrder: 2, isFavorite: true, budget: 0 },
        { id: '3', name: 'ìƒí™œë¹„ í†µì¥', balance: 0, displayOrder: 3, isFavorite: true, budget: 0 }
      ],

      categories: [
        { id: '1', name: 'ê¸‰ì—¬', icon: 'ğŸ’°', type: 'income', displayOrder: 1, isFavorite: true },
        { id: '2', name: 'ë¶€ìˆ˜ì…', icon: 'ğŸ’µ', type: 'income', displayOrder: 2, isFavorite: true },
        { id: '3', name: 'ì‹ë¹„', icon: 'ğŸš', type: 'expense', displayOrder: 1, isFavorite: true },
        { id: '4', name: 'ì¹´í˜', icon: 'â˜•', type: 'expense', displayOrder: 2, isFavorite: true },
        { id: '5', name: 'êµí†µ', icon: 'ğŸšŒ', type: 'expense', displayOrder: 3, isFavorite: true },
        { id: '6', name: 'ì‡¼í•‘', icon: 'ğŸ›’', type: 'expense', displayOrder: 4, isFavorite: true },
        { id: '7', name: 'ìƒí™œ', icon: 'ğŸ ', type: 'expense', displayOrder: 5, isFavorite: false },
        { id: '8', name: 'ì·¨ë¯¸', icon: 'ğŸ®', type: 'expense', displayOrder: 6, isFavorite: false },
        { id: '9', name: 'ì˜ë£Œ', icon: 'ğŸ¥', type: 'expense', displayOrder: 7, isFavorite: false },
        { id: '10', name: 'ê²½ì¡°ì‚¬', icon: 'ğŸ', type: 'expense', displayOrder: 8, isFavorite: false },
        { id: '11', name: 'ë¯¸ìš©', icon: 'ğŸ’‡', type: 'expense', displayOrder: 9, isFavorite: false },
        { id: '12', name: 'ê¸°íƒ€', icon: 'ğŸ“¦', type: 'expense', displayOrder: 10, isFavorite: false }
      ],

      transactions: [],
      statsFilter: 'month',
      searchQuery: '',
      expandedSections: {
        category: false,
        paymentMethod: false
      },

      useLocalStorage: true,
      supabaseClient: null,
      trendChart: null
    };

    // ============================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ============================================
    function formatNumber(num) {
      const numStr = String(num).replace(/[^\d]/g, '');
      if (!numStr) return '';
      return new Intl.NumberFormat('ko-KR').format(parseInt(numStr));
    }

    function parseFormattedNumber(str) {
      return parseInt(String(str).replace(/[^\d]/g, '')) || 0;
    }

    function formatAmount(amount) {
      return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
    }

    function formatMoney(amount) {
      return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
    }

    function formatDate(date) {
      const d = new Date(date);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    function formatDateKo(date) {
      const d = new Date(date);
      const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      return `${d.getMonth() + 1}ì›” ${d.getDate()}ì¼ (${days[d.getDay()]})`;
    }

    function getMonthRange(date) {
      const start = new Date(date.getFullYear(), date.getMonth(), 1);
      const end = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      return { start, end };
    }

    function getWeekRange(date) {
      const start = new Date(date);
      start.setDate(date.getDate() - date.getDay());
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      return { start, end };
    }

    function getYearRange(date) {
      const start = new Date(date.getFullYear(), 0, 1);
      const end = new Date(date.getFullYear(), 11, 31);
      return { start, end };
    }

    function getStatsPeriodRange() {
      if (state.statsFilter === 'week') {
        return getWeekRange(state.currentDate);
      } else if (state.statsFilter === 'year') {
        return getYearRange(state.currentDate);
      } else {
        return getMonthRange(state.currentDate);
      }
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ============================================
    // ë°ì´í„° ì €ì¥/ë¡œë“œ
    // ============================================
    function saveLocalData() {
      localStorage.setItem('household_data', JSON.stringify({
        users: state.users,
        paymentMethods: state.paymentMethods,
        assets: state.assets,
        categories: state.categories,
        transactions: state.transactions
      }));
    }

    async function saveToSupabase() {
      if (!state.supabaseClient) return;

      try {
        const data = {
          users: state.users,
          payment_methods: state.paymentMethods,
          assets: state.assets,
          categories: state.categories,
          transactions: state.transactions,
          updated_at: new Date().toISOString()
        };

        const { data: existing, error: selectError } = await state.supabaseClient
          .from('household_data')
          .select('id')
          .limit(1);

        if (selectError) {
          console.error('Supabase ì¡°íšŒ ì‹¤íŒ¨:', selectError);
          return;
        }

        if (existing && existing.length > 0) {
          const { error: updateError } = await state.supabaseClient
            .from('household_data')
            .update(data)
            .eq('id', existing[0].id);

          if (updateError) {
            console.error('Supabase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updateError);
          } else {
            console.log('âœ… Supabase ì €ì¥ ì™„ë£Œ');
            alert('ë™ê¸°í™” ì™„ë£Œ!');
          }
        } else {
          const { error: insertError } = await state.supabaseClient
            .from('household_data')
            .insert([data]);

          if (insertError) {
            console.error('Supabase ì‚½ì… ì‹¤íŒ¨:', insertError);
          } else {
            console.log('âœ… Supabase ì €ì¥ ì™„ë£Œ');
            alert('ë™ê¸°í™” ì™„ë£Œ!');
          }
        }
      } catch (error) {
        console.error('Supabase ì €ì¥ ì‹¤íŒ¨:', error);
        alert('ë™ê¸°í™” ì‹¤íŒ¨: ' + error.message);
      }
    }

    const debouncedSyncToSupabase = debounce(saveToSupabase, 5000);

    function saveData() {
      saveLocalData();
      if (!state.useLocalStorage && state.supabaseClient) {
        debouncedSyncToSupabase();
      }
    }

    function loadLocalData() {
      const saved = localStorage.getItem('household_data');
      if (saved) {
        const data = JSON.parse(saved);
        state.users = data.users || state.users;
        state.paymentMethods = data.paymentMethods || state.paymentMethods;
        state.assets = data.assets || state.assets;
        state.categories = data.categories || state.categories;
        state.transactions = data.transactions || [];
      }
    }

    async function loadFromSupabase() {
      if (!state.supabaseClient) return;

      try {
        const { data, error } = await state.supabaseClient
          .from('household_data')
          .select('*')
          .order('updated_at', { ascending: false })
          .limit(1);

        if (error) {
          console.error('Supabase ë¡œë“œ ì‹¤íŒ¨:', error);
          return;
        }

        if (data && data.length > 0) {
          const loadedData = data[0];
          state.users = loadedData.users || state.users;
          state.paymentMethods = loadedData.payment_methods || state.paymentMethods;
          state.assets = loadedData.assets || state.assets;
          state.categories = loadedData.categories || state.categories;
          state.transactions = loadedData.transactions || [];

          saveLocalData();
          console.log('âœ… Supabase ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
        }
      } catch (error) {
        console.error('Supabase ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    async function loadData() {
      loadLocalData();
      if (!state.useLocalStorage && state.supabaseClient) {
        await loadFromSupabase();
      }
    }

    // ============================================
    // ë Œë”ë§ í•¨ìˆ˜
    // ============================================
    function updateMonthDisplay() {
      const month = state.currentDate.getMonth() + 1;
      const year = state.currentDate.getFullYear();
      document.getElementById('currentMonth').textContent = `${year}ë…„ ${month}ì›”`;
    }

    function updateSummary() {
      const { start, end } = getMonthRange(state.currentDate);
      const monthTransactions = state.transactions.filter(t => {
        const tDate = new Date(t.transactionDate);
        return tDate >= start && tDate <= end;
      });

      const income = monthTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);

      const expense = monthTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);

      const balance = income - expense;

      document.getElementById('totalIncome').textContent = formatMoney(income);
      document.getElementById('totalExpense').textContent = formatMoney(expense);
      document.getElementById('totalBalance').textContent = formatMoney(balance);
    }

    function renderCalendar() {
      const year = state.currentDate.getFullYear();
      const month = state.currentDate.getMonth();

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      const startDay = new Date(firstDay);
      startDay.setDate(startDay.getDate() - firstDay.getDay());

      const endDay = new Date(lastDay);
      endDay.setDate(endDay.getDate() + (6 - lastDay.getDay()));

      let html = '';

      const dayHeaders = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      dayHeaders.forEach((day, index) => {
        let className = 'calendar-day-header';
        if (index === 0) className += ' sun';
        if (index === 6) className += ' sat';
        html += `<div class="${className}">${day}</div>`;
      });

      const current = new Date(startDay);
      const todayStr = formatDate(new Date());

      while (current <= endDay) {
        const dateStr = formatDate(current);
        const isCurrentMonth = current.getMonth() === month;
        const isToday = todayStr === dateStr;
        const isSelected = state.selectedDate === dateStr;
        const dayOfWeek = current.getDay();

        const dayTransactions = state.transactions.filter(t => t.transactionDate === dateStr);
        const income = dayTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const expense = dayTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

        let className = 'calendar-day';
        if (!isCurrentMonth) className += ' other-month';
        if (isToday) className += ' today';
        if (isSelected) className += ' selected';
        if (dayOfWeek === 0) className += ' sun';
        if (dayOfWeek === 6) className += ' sat';

        html += `
          <div class="${className}" onclick="onCalendarDayClick('${dateStr}')" ondblclick="onCalendarDayDoubleClick('${dateStr}')">
            <div class="calendar-day-number">${current.getDate()}</div>
            ${income > 0 ? `<div class="calendar-day-income">${formatAmount(income)}</div>` : ''}
            ${expense > 0 ? `<div class="calendar-day-expense">${formatAmount(expense)}</div>` : ''}
          </div>
        `;

        current.setDate(current.getDate() + 1);
      }

      document.getElementById('calendarGrid').innerHTML = html;
    }

    function onCalendarDayClick(dateStr) {
      state.selectedDate = dateStr;
      const todayStr = formatDate(new Date());
      // ì˜¤ëŠ˜ì´ ì•„ë‹Œ ë‹¤ë¥¸ ë‚ ì§œë¥¼ ì„ íƒí–ˆì„ ë•Œ bodyì— í‘œì‹œ
      document.body.setAttribute('data-has-selected', dateStr !== todayStr ? 'true' : 'false');
      renderCalendar();
      renderSelectedDateTransactions(dateStr);
    }

    function onCalendarDayDoubleClick(dateStr) {
      openTransactionModal();
      document.getElementById('dateInput').value = dateStr;
    }

    function renderSelectedDateTransactions(dateStr) {
      const dayTransactions = state.transactions.filter(t => t.transactionDate === dateStr);

      document.getElementById('calendarSelectedDate').textContent = formatDateKo(dateStr);

      if (dayTransactions.length === 0) {
        document.getElementById('calendarTransactionList').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-text">ì´ ë‚ ì§œì— ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        `;
        return;
      }

      let html = dayTransactions.map(t => renderTransactionItem(t, false)).join('');
      document.getElementById('calendarTransactionList').innerHTML = html;
    }

    function renderTransactionList() {
      const { start, end } = getMonthRange(state.currentDate);
      let transactions = state.transactions.filter(t => {
        const tDate = new Date(t.transactionDate);
        return tDate >= start && tDate <= end;
      });

      if (state.logFilter !== 'all') {
        transactions = transactions.filter(t => t.type === state.logFilter);
      }

      if (state.searchQuery) {
        const query = state.searchQuery.toLowerCase();
        transactions = transactions.filter(t => {
          const category = state.categories.find(c => c.id === t.categoryId);
          const paymentMethod = state.paymentMethods.find(p => p.id === t.paymentMethodId);
          const user = state.users.find(u => u.id === t.userId);

          return (
            (t.memo && t.memo.toLowerCase().includes(query)) ||
            (category && category.name.toLowerCase().includes(query)) ||
            (paymentMethod && paymentMethod.name.toLowerCase().includes(query)) ||
            (user && user.name.toLowerCase().includes(query))
          );
        });
      }

      transactions.sort((a, b) => new Date(b.transactionDate) - new Date(a.transactionDate));

      let html = '';
      if (transactions.length === 0) {
        html = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div class="empty-state-text">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>';
      } else {
        html = transactions.map(t => renderTransactionItem(t, true)).join('');
      }

      document.getElementById('transactionList').innerHTML = html;
    }

    function renderTransactionItem(t, showDate = false) {
      const user = state.users.find(u => u.id === t.userId);
      const category = state.categories.find(c => c.id === t.categoryId);
      const paymentMethod = state.paymentMethods.find(p => p.id === t.paymentMethodId);
      const asset = state.assets.find(a => a.id === t.assetId);
      const toAsset = t.toAssetId ? state.assets.find(a => a.id === t.toAssetId) : null;

      let methodText = '';
      if (t.type === 'transfer') {
        methodText = `${asset?.name || ''} â†’ ${toAsset?.name || ''}`;
      } else {
        methodText = `${paymentMethod?.name || ''} Â· ${asset?.name || ''}`;
      }

      const amountClass = t.type === 'income' ? 'income' : (t.type === 'expense' ? 'expense' : 'transfer');
      const amountPrefix = t.type === 'income' ? '+' : (t.type === 'expense' ? '-' : '');

      const categoryDisplay = category ? (category.icon ? `${category.icon} ${category.name}` : category.name) : (t.type === 'transfer' ? 'ìì‚°ì´ë™' : '');

      const dateDisplay = showDate ? formatDateKo(t.transactionDate) : '';

      return `
        <div class="transaction-item">
          <div class="transaction-left">
            ${showDate ? `<span class="transaction-date-badge">${dateDisplay}</span>` : ''}
            ${user ? `<span class="transaction-user">${user.name}</span>` : ''}
            <div class="transaction-category">${categoryDisplay}</div>
            ${methodText ? `<div class="transaction-method">${methodText}</div>` : ''}
            ${t.memo ? `<div class="transaction-method">${t.memo}</div>` : ''}
          </div>
          <div class="transaction-amount ${amountClass}">
            ${amountPrefix}${formatMoney(t.amount)}
          </div>
        </div>
      `;
    }

    function renderAssetsList() {
      const sortedAssets = [...state.assets].sort((a, b) => a.displayOrder - b.displayOrder);

      let html = sortedAssets.map(asset => {
        const balance = calculateAssetBalance(asset.id);
        const budget = asset.budget || 0;
        const { start, end } = getMonthRange(state.currentDate);

        const assetTransactions = state.transactions.filter(t => {
          const tDate = new Date(t.transactionDate);
          return tDate >= start && tDate <= end && t.assetId === asset.id;
        });

        const spent = assetTransactions
          .filter(t => t.type === 'expense')
          .reduce((sum, t) => sum + t.amount, 0);

        let progressPercent = 0;
        let progressClass = '';

        if (budget > 0) {
          progressPercent = Math.min((spent / budget) * 100, 100);
          if (progressPercent >= 100) {
            progressClass = 'danger';
          } else if (progressPercent >= 80) {
            progressClass = 'warning';
          }
        }

        return `
          <div class="asset-card" onclick="showAssetTransactions('${asset.id}', '${asset.name}')">
            <div class="asset-header">
              <span class="asset-name">${asset.name}</span>
              <span class="asset-balance">${formatMoney(balance)}</span>
            </div>
            ${budget > 0 ? `
              <div class="asset-budget-bar">
                <div class="budget-progress ${progressClass}" style="width: ${progressPercent}%"></div>
              </div>
              <div class="asset-budget-info">
                <span>ì§€ì¶œ: ${formatMoney(spent)}</span>
                <span>ì˜ˆì‚°: ${formatMoney(budget)}</span>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');

      document.getElementById('assetsList').innerHTML = html;
    }

    function calculateAssetBalance(assetId) {
      let balance = 0;

      state.transactions.forEach(t => {
        if (t.assetId === assetId) {
          if (t.type === 'income') {
            balance += t.amount;
          } else if (t.type === 'expense') {
            balance -= t.amount;
          } else if (t.type === 'transfer') {
            balance -= t.amount;
          }
        }

        if (t.type === 'transfer' && t.toAssetId === assetId) {
          balance += t.amount;
        }
      });

      return balance;
    }

    function showAssetTransactions(assetId, assetName) {
      const assetTransactions = state.transactions.filter(t =>
        t.assetId === assetId || (t.type === 'transfer' && t.toAssetId === assetId)
      );

      assetTransactions.sort((a, b) => new Date(b.transactionDate) - new Date(a.transactionDate));

      document.getElementById('assetModalTitle').textContent = `${assetName} ë‚´ì—­`;

      if (assetTransactions.length === 0) {
        document.getElementById('assetTransactionsList').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“</div>
            <div class="empty-state-text">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        `;
      } else {
        const html = assetTransactions.map(t => renderTransactionItem(t, true)).join('');
        document.getElementById('assetTransactionsList').innerHTML = html;
      }

      document.getElementById('assetTransactionsModal').classList.add('active');
    }

    function renderStats() {
      const { start, end } = getStatsPeriodRange();
      const monthTransactions = state.transactions.filter(t => {
        const tDate = new Date(t.transactionDate);
        return tDate >= start && tDate <= end && t.type === 'expense';
      });

      let html = '';

      // ì‚¬ìš©ìë³„ ì§€ì¶œ
      const userExpenses = {};
      state.users.forEach(u => {
        userExpenses[u.id] = monthTransactions
          .filter(t => t.userId === u.id)
          .reduce((sum, t) => sum + t.amount, 0);
      });

      const maxUserExpense = Math.max(...Object.values(userExpenses), 1);

      html += '<div class="chart"><div class="chart-title">ì‚¬ìš©ìë³„ ì§€ì¶œ</div><div class="bar-chart">';
      state.users.forEach(user => {
        const amount = userExpenses[user.id] || 0;
        const percent = (amount / maxUserExpense) * 100;
        html += `
          <div class="bar-item">
            <div class="bar-label">
              <span>${user.name}</span>
              <span>${formatMoney(amount)}</span>
            </div>
            <div class="bar-bg">
              <div class="bar-fill" style="width: ${percent}%"></div>
            </div>
          </div>
        `;
      });
      html += '</div></div>';

      // ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ
      const categoryExpenses = {};
      monthTransactions.forEach(t => {
        if (!categoryExpenses[t.categoryId]) categoryExpenses[t.categoryId] = 0;
        categoryExpenses[t.categoryId] += t.amount;
      });

      const sortedCategories = Object.entries(categoryExpenses)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      if (sortedCategories.length > 0) {
        const maxCategoryExpense = sortedCategories[0][1];
        html += '<div class="chart"><div class="chart-title">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</div><div class="bar-chart">';
        sortedCategories.forEach(([catId, amount]) => {
          const category = state.categories.find(c => c.id === catId);
          const percent = (amount / maxCategoryExpense) * 100;
          const categoryDisplay = category ? (category.icon ? `${category.icon} ${category.name}` : category.name) : 'ê¸°íƒ€';
          html += `
            <div class="bar-item">
              <div class="bar-label">
                <span>${categoryDisplay}</span>
                <span>${formatMoney(amount)}</span>
              </div>
              <div class="bar-bg">
                <div class="bar-fill" style="width: ${percent}%"></div>
              </div>
            </div>
          `;
        });
        html += '</div></div>';
      }

      // ê²°ì œìˆ˜ë‹¨ë³„ ì§€ì¶œ
      const methodExpenses = {};
      monthTransactions.forEach(t => {
        if (!methodExpenses[t.paymentMethodId]) methodExpenses[t.paymentMethodId] = 0;
        methodExpenses[t.paymentMethodId] += t.amount;
      });

      const sortedMethods = Object.entries(methodExpenses)
        .sort((a, b) => b[1] - a[1]);

      if (sortedMethods.length > 0) {
        const maxMethodExpense = sortedMethods[0][1];
        html += '<div class="chart"><div class="chart-title">ê²°ì œìˆ˜ë‹¨ë³„ ì§€ì¶œ</div><div class="bar-chart">';
        sortedMethods.forEach(([methodId, amount]) => {
          const method = state.paymentMethods.find(m => m.id === methodId);
          const percent = (amount / maxMethodExpense) * 100;
          html += `
            <div class="bar-item">
              <div class="bar-label">
                <span>${method?.name || 'ê¸°íƒ€'}</span>
                <span>${formatMoney(amount)}</span>
              </div>
              <div class="bar-bg">
                <div class="bar-fill" style="width: ${percent}%"></div>
              </div>
            </div>
          `;
        });
        html += '</div></div>';
      }

      document.getElementById('statsCharts').innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div class="empty-state-text">í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>';

      renderTrendChart();
    }

    function renderTrendChart() {
      const canvas = document.getElementById('trendChart');
      const ctx = canvas.getContext('2d');

      if (state.trendChart) {
        state.trendChart.destroy();
      }

      let labels = [];
      let incomeData = [];
      let expenseData = [];

      if (state.statsFilter === 'week') {
        // ì£¼ê°„: ìµœê·¼ 7ì¼
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = formatDate(date);

          const dayTransactions = state.transactions.filter(t => t.transactionDate === dateStr);
          const income = dayTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
          const expense = dayTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

          labels.push(`${date.getMonth() + 1}/${date.getDate()}`);
          incomeData.push(income);
          expenseData.push(expense);
        }
      } else if (state.statsFilter === 'year') {
        // ì—°ê°„: ìµœê·¼ 12ê°œì›”
        for (let i = 11; i >= 0; i--) {
          const date = new Date(state.currentDate);
          date.setMonth(date.getMonth() - i);
          const { start, end } = getMonthRange(date);

          const monthTransactions = state.transactions.filter(t => {
            const tDate = new Date(t.transactionDate);
            return tDate >= start && tDate <= end;
          });

          const income = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
          const expense = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

          labels.push(`${date.getMonth() + 1}ì›”`);
          incomeData.push(income);
          expenseData.push(expense);
        }
      } else {
        // ì›”ê°„: ìµœê·¼ 6ê°œì›”
        for (let i = 5; i >= 0; i--) {
          const date = new Date(state.currentDate);
          date.setMonth(date.getMonth() - i);
          const { start, end } = getMonthRange(date);

          const monthTransactions = state.transactions.filter(t => {
            const tDate = new Date(t.transactionDate);
            return tDate >= start && tDate <= end;
          });

          const income = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
          const expense = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

          labels.push(`${date.getMonth() + 1}ì›”`);
          incomeData.push(income);
          expenseData.push(expense);
        }
      }

      state.trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'ìˆ˜ì…',
              data: incomeData,
              borderColor: '#0AC569',
              backgroundColor: 'rgba(10, 197, 105, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'ì§€ì¶œ',
              data: expenseData,
              borderColor: '#F04452',
              backgroundColor: 'rgba(240, 68, 82, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value >= 10000 ? (value / 10000) + 'ë§Œ' : value;
                }
              }
            }
          }
        }
      });
    }

    function renderSelectGrid(containerId, items, selectedId, onClick, allowExpand = false) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const isExpanded = state.expandedSections[containerId];
      const displayItems = (allowExpand && !isExpanded)
        ? items.filter(item => item.isFavorite)
        : items;

      let html = displayItems.map(item => {
        const selected = item.id === selectedId ? 'selected' : '';
        const displayName = item.icon ? `${item.icon} ${item.name}` : item.name;
        return `<div class="select-item ${selected}" onclick="selectItem('${containerId}', '${item.id}')">${displayName}</div>`;
      }).join('');

      if (allowExpand && items.length > displayItems.length) {
        html += `<button class="expand-toggle" onclick="toggleExpand('${containerId}')">
          ${isExpanded ? 'ì ‘ê¸° â–²' : `ë”ë³´ê¸° (${items.length - displayItems.length}ê°œ) â–¼`}
        </button>`;
      }

      container.innerHTML = html;
    }

    function renderPaymentMethodsSettings() {
      const sorted = [...state.paymentMethods].sort((a, b) => a.displayOrder - b.displayOrder);
      const html = sorted.map(method => `
        <div class="settings-item-card">
          <div class="item-content">
            <div class="item-name">${method.name}</div>
            <div class="item-meta">${method.isFavorite ? 'ì¦ê²¨ì°¾ê¸° â€¢ ' : ''}ìˆœì„œ ${method.displayOrder}</div>
          </div>
          <div class="item-actions">
            <button class="icon-btn reorder" onclick="moveItemUp('paymentMethods', '${method.id}')">â†‘</button>
            <button class="icon-btn reorder" onclick="moveItemDown('paymentMethods', '${method.id}')">â†“</button>
            <button class="icon-btn ${method.isFavorite ? 'favorite' : ''}" onclick="toggleFavorite('paymentMethods', '${method.id}')">â˜…</button>
            <button class="icon-btn edit" onclick="editItem('paymentMethods', '${method.id}')">edit</button>
            <button class="icon-btn delete" onclick="deleteItem('paymentMethods', '${method.id}')">del</button>
          </div>
        </div>
      `).join('');
      document.getElementById('paymentMethodsList').innerHTML = html;
    }

    function renderAssetsSettings() {
      const sorted = [...state.assets].sort((a, b) => a.displayOrder - b.displayOrder);
      const html = sorted.map(asset => `
        <div class="settings-item-card">
          <div class="item-content">
            <div class="item-name">${asset.name}</div>
            <div class="item-meta">${asset.isFavorite ? 'ì¦ê²¨ì°¾ê¸° â€¢ ' : ''}ìˆœì„œ ${asset.displayOrder}</div>
          </div>
          <div class="item-actions">
            <button class="icon-btn reorder" onclick="moveItemUp('assets', '${asset.id}')">â†‘</button>
            <button class="icon-btn reorder" onclick="moveItemDown('assets', '${asset.id}')">â†“</button>
            <button class="icon-btn ${asset.isFavorite ? 'favorite' : ''}" onclick="toggleFavorite('assets', '${asset.id}')">â˜…</button>
            <button class="icon-btn edit" onclick="editItem('assets', '${asset.id}')">edit</button>
            <button class="icon-btn delete" onclick="deleteItem('assets', '${asset.id}')">del</button>
          </div>
        </div>
      `).join('');
      document.getElementById('assetsSettingsList').innerHTML = html;
    }

    function renderCategoriesSettings() {
      const sorted = [...state.categories].sort((a, b) => {
        if (a.type !== b.type) return a.type === 'income' ? -1 : 1;
        return a.displayOrder - b.displayOrder;
      });

      const html = sorted.map(cat => {
        return `
        <div class="settings-item-card">
          <div class="item-content">
            <div class="item-name">${cat.name}</div>
            <div class="item-meta">${cat.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ'} â€¢ ${cat.isFavorite ? 'ì¦ê²¨ì°¾ê¸° â€¢ ' : ''}ìˆœì„œ ${cat.displayOrder}</div>
          </div>
          <div class="item-actions">
            <button class="icon-btn reorder" onclick="moveItemUp('categories', '${cat.id}')">â†‘</button>
            <button class="icon-btn reorder" onclick="moveItemDown('categories', '${cat.id}')">â†“</button>
            <button class="icon-btn ${cat.isFavorite ? 'favorite' : ''}" onclick="toggleFavorite('categories', '${cat.id}')">â˜…</button>
            <button class="icon-btn edit" onclick="editItem('categories', '${cat.id}')">edit</button>
            <button class="icon-btn delete" onclick="deleteItem('categories', '${cat.id}')">del</button>
          </div>
        </div>
      `;
      }).join('');
      document.getElementById('categoriesList').innerHTML = html;
    }

    // ============================================
    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    // ============================================
    function openTransactionModal() {
      state.selectedUser = state.users[0].id;
      state.selectedType = 'expense';
      state.selectedCategory = null;
      state.selectedPaymentMethod = null;
      state.selectedAsset = null;

      document.getElementById('amountInput').value = '';
      document.getElementById('dateInput').value = state.selectedDate || formatDate(new Date());
      document.getElementById('memoInput').value = '';

      renderSelectGrid('userSelect', state.users, state.selectedUser);
      updateTransactionModalForType();

      document.getElementById('transactionModal').classList.add('active');
    }

    function updateTransactionModalForType() {
      const categories = state.categories.filter(c => c.type === state.selectedType);
      renderSelectGrid('categorySelect', categories, state.selectedCategory, null, true);
      renderSelectGrid('paymentMethodSelect', state.paymentMethods, state.selectedPaymentMethod, null, true);
      renderSelectGrid('assetSelect', state.assets, state.selectedAsset, null, true);
    }

    function selectItem(containerId, itemId) {
      if (containerId === 'userSelect') {
        state.selectedUser = itemId;
        renderSelectGrid('userSelect', state.users, state.selectedUser);
      } else if (containerId === 'categorySelect') {
        state.selectedCategory = itemId;
        const categories = state.categories.filter(c => c.type === state.selectedType);
        renderSelectGrid('categorySelect', categories, state.selectedCategory, null, true);
      } else if (containerId === 'paymentMethodSelect') {
        state.selectedPaymentMethod = itemId;
        renderSelectGrid('paymentMethodSelect', state.paymentMethods, state.selectedPaymentMethod, null, true);
      } else if (containerId === 'assetSelect') {
        state.selectedAsset = itemId;
        renderSelectGrid('assetSelect', state.assets, state.selectedAsset, null, true);
      } else if (containerId === 'fromAssetSelect') {
        state.selectedFromAsset = itemId;
        renderSelectGrid('fromAssetSelect', state.assets, state.selectedFromAsset);
      } else if (containerId === 'toAssetSelect') {
        state.selectedToAsset = itemId;
        renderSelectGrid('toAssetSelect', state.assets, state.selectedToAsset);
      }
    }

    function toggleExpand(containerId) {
      state.expandedSections[containerId] = !state.expandedSections[containerId];

      if (containerId === 'categorySelect') {
        const categories = state.categories.filter(c => c.type === state.selectedType);
        renderSelectGrid('categorySelect', categories, state.selectedCategory, null, true);
      } else if (containerId === 'paymentMethodSelect') {
        renderSelectGrid('paymentMethodSelect', state.paymentMethods, state.selectedPaymentMethod, null, true);
      } else if (containerId === 'assetSelect') {
        renderSelectGrid('assetSelect', state.assets, state.selectedAsset, null, true);
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function saveTransaction() {
      const amount = parseFormattedNumber(document.getElementById('amountInput').value);
      const date = document.getElementById('dateInput').value;
      const memo = document.getElementById('memoInput').value;

      if (!amount || amount <= 0) {
        alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!state.selectedUser) {
        alert('ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!state.selectedCategory) {
        alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!state.selectedPaymentMethod) {
        alert('ê²°ì œìˆ˜ë‹¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!state.selectedAsset) {
        alert('ìì‚°ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const transaction = {
        id: generateId(),
        type: state.selectedType,
        userId: state.selectedUser,
        amount: amount,
        categoryId: state.selectedCategory,
        paymentMethodId: state.selectedPaymentMethod,
        assetId: state.selectedAsset,
        transactionDate: date,
        memo: memo,
        createdAt: new Date().toISOString()
      };

      state.transactions.push(transaction);
      saveData();
      renderAll();
      closeModal('transactionModal');
    }

    function saveTransfer() {
      const amount = parseFormattedNumber(document.getElementById('transferAmountInput').value);
      const date = document.getElementById('transferDateInput').value;

      if (!amount || amount <= 0) {
        alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!state.selectedFromAsset) {
        alert('ì¶œë°œ ìì‚°ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!state.selectedToAsset) {
        alert('ë„ì°© ìì‚°ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (state.selectedFromAsset === state.selectedToAsset) {
        alert('ê°™ì€ ìì‚°ìœ¼ë¡œëŠ” ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const transaction = {
        id: generateId(),
        type: 'transfer',
        userId: state.users[0].id,
        amount: amount,
        assetId: state.selectedFromAsset,
        toAssetId: state.selectedToAsset,
        transactionDate: date,
        memo: 'ìì‚°ì´ë™',
        createdAt: new Date().toISOString()
      };

      state.transactions.push(transaction);
      saveData();
      renderAll();
      closeModal('transferModal');
    }

    function openBudgetModal() {
      let html = '';

      state.assets.forEach(asset => {
        const currentBudget = asset.budget || 0;
        html += `
          <div class="form-group">
            <label class="form-label">${asset.name} ì˜ˆì‚°</label>
            <input type="text" inputmode="numeric" class="form-input" id="budget-${asset.id}" value="${currentBudget > 0 ? formatNumber(currentBudget) : ''}" placeholder="ì˜ˆì‚° ì…ë ¥">
          </div>
        `;
      });

      html += '<button class="btn btn-primary" onclick="saveBudgets()">ì €ì¥</button>';

      document.getElementById('budgetFormContent').innerHTML = html;
      document.getElementById('budgetModal').classList.add('active');

      // ê¸ˆì•¡ í¬ë§·íŒ… ì´ë²¤íŠ¸ ì¶”ê°€
      state.assets.forEach(asset => {
        const input = document.getElementById(`budget-${asset.id}`);
        input.addEventListener('input', (e) => {
          const formatted = formatNumber(e.target.value);
          e.target.value = formatted;
        });
      });
    }

    function saveBudgets() {
      state.assets.forEach(asset => {
        const input = document.getElementById(`budget-${asset.id}`);
        asset.budget = parseFormattedNumber(input.value);
      });

      saveData();
      renderAssetsList();
      closeModal('budgetModal');
      alert('ì˜ˆì‚°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function toggleFavorite(type, id) {
      const items = state[type];
      const item = items.find(i => i.id === id);
      if (item) {
        item.isFavorite = !item.isFavorite;
        saveData();

        if (type === 'paymentMethods') {
          renderPaymentMethodsSettings();
        } else if (type === 'assets') {
          renderAssetsSettings();
        } else if (type === 'categories') {
          renderCategoriesSettings();
        }
      }
    }

    function editItem(type, id) {
      const items = state[type];
      const item = items.find(i => i.id === id);
      if (!item) return;

      const newName = prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', item.name);
      if (newName && newName.trim()) {
        item.name = newName.trim();
        saveData();

        if (type === 'paymentMethods') {
          renderPaymentMethodsSettings();
        } else if (type === 'assets') {
          renderAssetsSettings();
        } else if (type === 'categories') {
          renderCategoriesSettings();
        }

        renderAll();
      }
    }

    function moveItemUp(type, id) {
      const items = state[type];
      const sorted = [...items].sort((a, b) => {
        if (type === 'categories' && a.type !== b.type) {
          return a.type === 'income' ? -1 : 1;
        }
        return a.displayOrder - b.displayOrder;
      });

      const index = sorted.findIndex(i => i.id === id);
      if (index > 0) {
        const temp = sorted[index].displayOrder;
        sorted[index].displayOrder = sorted[index - 1].displayOrder;
        sorted[index - 1].displayOrder = temp;

        saveData();

        if (type === 'paymentMethods') {
          renderPaymentMethodsSettings();
        } else if (type === 'assets') {
          renderAssetsSettings();
        } else if (type === 'categories') {
          renderCategoriesSettings();
        }
      }
    }

    function moveItemDown(type, id) {
      const items = state[type];
      const sorted = [...items].sort((a, b) => {
        if (type === 'categories' && a.type !== b.type) {
          return a.type === 'income' ? -1 : 1;
        }
        return a.displayOrder - b.displayOrder;
      });

      const index = sorted.findIndex(i => i.id === id);
      if (index < sorted.length - 1) {
        const temp = sorted[index].displayOrder;
        sorted[index].displayOrder = sorted[index + 1].displayOrder;
        sorted[index + 1].displayOrder = temp;

        saveData();

        if (type === 'paymentMethods') {
          renderPaymentMethodsSettings();
        } else if (type === 'assets') {
          renderAssetsSettings();
        } else if (type === 'categories') {
          renderCategoriesSettings();
        }
      }
    }

    function deleteItem(type, id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const items = state[type];
      const index = items.findIndex(i => i.id === id);
      if (index > -1) {
        items.splice(index, 1);
        saveData();

        if (type === 'paymentMethods') {
          renderPaymentMethodsSettings();
        } else if (type === 'assets') {
          renderAssetsSettings();
        } else if (type === 'categories') {
          renderCategoriesSettings();
        }

        renderAll();
      }
    }

    function addNewItem(type, categoryType = null) {
      const name = prompt('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
      if (!name || !name.trim()) return;

      const items = state[type];
      const maxOrder = Math.max(...items.map(i => i.displayOrder || 0), 0);

      const newItem = {
        id: generateId(),
        name: name.trim(),
        displayOrder: maxOrder + 1,
        isFavorite: true
      };

      if (type === 'categories') {
        newItem.type = categoryType;
        newItem.icon = 'ğŸ“';
      }

      if (type === 'assets') {
        newItem.balance = 0;
        newItem.budget = 0;
      }

      items.push(newItem);
      saveData();

      if (type === 'paymentMethods') {
        renderPaymentMethodsSettings();
      } else if (type === 'assets') {
        renderAssetsSettings();
      } else if (type === 'categories') {
        renderCategoriesSettings();
      }

      renderAll();
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(`${tabName}-content`).classList.add('active');

      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      // bodyì— í˜„ì¬ í™œì„± íƒ­ ì„¤ì • (í—¤ë” í‘œì‹œ/ìˆ¨ê¹€ ì œì–´)
      document.body.setAttribute('data-active-tab', tabName);

      // ì›”ê°„ ìš”ì•½ê³¼ ì›” ì„ íƒê¸°ë¥¼ ë‹¬ë ¥ íƒ­ì—ë§Œ í‘œì‹œ
      const summaryElement = document.querySelector('.summary');
      const monthSelectorElement = document.querySelector('.month-selector');

      if (tabName === 'calendar') {
        summaryElement.style.display = 'block';
        monthSelectorElement.style.display = 'flex';
        renderCalendar();
        renderSelectedDateTransactions(state.selectedDate);
      } else {
        summaryElement.style.display = 'none';
        monthSelectorElement.style.display = 'none';
        if (tabName === 'log') {
          renderTransactionList();
        } else if (tabName === 'assets') {
          renderAssetsList();
        } else if (tabName === 'stats') {
          renderStats();
        }
      }
    }

    function renderAll() {
      updateMonthDisplay();
      updateSummary();
      renderCalendar();
      renderSelectedDateTransactions(state.selectedDate);
      renderTransactionList();
      renderAssetsList();
      renderStats();
      renderPaymentMethodsSettings();
      renderAssetsSettings();
      renderCategoriesSettings();
    }

    // ============================================
    // ì´ˆê¸°í™”
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      renderAll();

      // Supabase ì´ˆê¸°í™” (ê¸°ë³¸ê°’ ì‚¬ìš©)
      try {
        if (typeof supabase !== 'undefined') {
          state.supabaseClient = supabase.createClient(
            'https://zmnzfeicabvquwbxgjwt.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inptbnpmei1jYWJ2cXV3Yngand3dCIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNzM0MzgzNzAwLCJleHAiOjIwNDk5NTk3MDB9.sb_publishable_EUBiU6pKPHdimu-roGXrag_CK9rWVdm'
          );
          state.useLocalStorage = false;
        }
      } catch (error) {
        console.error('Supabase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      }

      // ì›” ë³€ê²½
      document.getElementById('prevMonth').addEventListener('click', () => {
        state.currentDate.setMonth(state.currentDate.getMonth() - 1);
        renderAll();
      });

      document.getElementById('nextMonth').addEventListener('click', () => {
        state.currentDate.setMonth(state.currentDate.getMonth() + 1);
        renderAll();
      });

      // íƒ­ ì „í™˜
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const tab = item.dataset.tab;
          switchTab(tab);
        });
      });

      // ê±°ë˜ ì¶”ê°€ ë²„íŠ¼
      document.getElementById('addTransactionBtn').addEventListener('click', openTransactionModal);

      // ê±°ë˜ íƒ€ì… ì„ íƒ
      document.querySelectorAll('[data-type]').forEach(item => {
        item.addEventListener('click', () => {
          document.querySelectorAll('[data-type]').forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
          state.selectedType = item.dataset.type;
          updateTransactionModalForType();
        });
      });

      // ê¸ˆì•¡ ì…ë ¥ í¬ë§·íŒ…
      document.getElementById('amountInput').addEventListener('input', (e) => {
        const formatted = formatNumber(e.target.value);
        e.target.value = formatted;
      });

      document.getElementById('transferAmountInput').addEventListener('input', (e) => {
        const formatted = formatNumber(e.target.value);
        e.target.value = formatted;
      });

      // ê¸ˆì•¡ ì´ˆê¸°í™”
      document.getElementById('resetAmountBtn').addEventListener('click', () => {
        document.getElementById('amountInput').value = '';
      });

      document.getElementById('resetTransferAmountBtn').addEventListener('click', () => {
        document.getElementById('transferAmountInput').value = '';
      });

      // ë¹ ë¥¸ ê¸ˆì•¡ ì¶”ê°€
      document.querySelectorAll('.quick-amount-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const amount = parseInt(btn.dataset.amount);
          const target = btn.dataset.target;

          let input;
          if (target === 'transfer') {
            input = document.getElementById('transferAmountInput');
          } else {
            input = document.getElementById('amountInput');
          }

          const currentAmount = parseFormattedNumber(input.value);
          const newAmount = currentAmount + amount;
          input.value = formatNumber(newAmount);
        });
      });

      // ê±°ë˜ ì €ì¥
      document.getElementById('saveTransaction').addEventListener('click', saveTransaction);

      // ìì‚° ì´ë™
      document.getElementById('transferAssetBtn').addEventListener('click', () => {
        state.selectedFromAsset = null;
        state.selectedToAsset = null;
        document.getElementById('transferAmountInput').value = '';
        document.getElementById('transferDateInput').value = formatDate(new Date());

        renderSelectGrid('fromAssetSelect', state.assets, state.selectedFromAsset);
        renderSelectGrid('toAssetSelect', state.assets, state.selectedToAsset);

        document.getElementById('transferModal').classList.add('active');
      });

      document.getElementById('saveTransfer').addEventListener('click', saveTransfer);

      // ì˜ˆì‚° ì„¤ì •
      document.getElementById('setBudgetBtn').addEventListener('click', openBudgetModal);

      // í•„í„° ë²„íŠ¼
      document.querySelectorAll('#logFilters .filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#logFilters .filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.logFilter = btn.dataset.filter;
          renderTransactionList();
        });
      });

      // í†µê³„ í•„í„°
      document.querySelectorAll('[data-period]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.statsFilter = btn.dataset.period;
          renderStats();
        });
      });

      // ê²€ìƒ‰
      document.getElementById('searchInput').addEventListener('input', (e) => {
        state.searchQuery = e.target.value;
        renderTransactionList();
      });

      // ë™ê¸°í™”
      document.getElementById('syncData').addEventListener('click', async () => {
        const button = document.getElementById('syncData');
        const originalText = button.innerHTML;

        try {
          button.disabled = true;
          button.innerHTML = '<span>ğŸ”„</span><span>ë™ê¸°í™” ì¤‘...</span>';
          button.style.opacity = '0.6';

          await saveToSupabase();
          await loadFromSupabase();
          renderAll();

          // ì„±ê³µ í”¼ë“œë°±
          button.innerHTML = '<span>âœ“</span><span>ë™ê¸°í™” ì™„ë£Œ!</span>';
          button.style.background = 'var(--success)';

          setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = '';
            button.style.opacity = '';
            button.disabled = false;
          }, 2000);
        } catch (error) {
          // ì‹¤íŒ¨ í”¼ë“œë°±
          button.innerHTML = '<span>âœ•</span><span>ë™ê¸°í™” ì‹¤íŒ¨</span>';
          button.style.background = 'var(--danger)';

          setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = '';
            button.style.opacity = '';
            button.disabled = false;
          }, 2000);

          console.error('ë™ê¸°í™” ì˜¤ë¥˜:', error);
        }
      });

      // ê²°ì œìˆ˜ë‹¨/ìì‚°/ì¹´í…Œê³ ë¦¬ ì¶”ê°€
      document.getElementById('addPaymentMethod').addEventListener('click', () => addNewItem('paymentMethods'));
      document.getElementById('addAsset').addEventListener('click', () => addNewItem('assets'));
      document.getElementById('addCategory').addEventListener('click', () => {
        const type = confirm('ìˆ˜ì… ì¹´í…Œê³ ë¦¬ì…ë‹ˆê¹Œ? (ì·¨ì†Œí•˜ë©´ ì§€ì¶œ)') ? 'income' : 'expense';
        addNewItem('categories', type);
      });

      // ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('active');
          }
        });
      });
    });

    // Service Worker ë“±ë¡ (PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('Service Worker registered:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>