<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ìƒí™œ ê°€ê³„ë¶€">
  <link rel="manifest" href="manifest.json">
  <title>ìƒí™œ ê°€ê³„ë¶€</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }

    :root {
      --primary: #3182F6;
      --primary-dark: #1B64DA;
      --success: #0AC569;
      --danger: #F04452;
      --warning: #FF8A00;
      --gray-50: #F9FAFB;
      --gray-100: #F2F4F6;
      --gray-200: #E5E8EB;
      --gray-300: #D1D6DB;
      --gray-400: #B0B8C1;
      --gray-500: #8B95A1;
      --gray-600: #6B7684;
      --gray-700: #4E5968;
      --gray-800: #333D4B;
      --gray-900: #191F28;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", "Pretendard", "Segoe UI", Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: var(--gray-50);
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      color: var(--gray-900);
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      background: var(--gray-50);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: calc(70px + env(safe-area-inset-bottom));
    }

    /* í—¤ë” */
    .header {
      background: white;
      padding: max(20px, env(safe-area-inset-top)) 8px 16px;
      border-bottom: 1px solid var(--gray-100);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .header h1 {
      font-size: 22px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 16px;
      letter-spacing: -0.5px;
      padding: 0 12px;
    }

    .month-selector {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 12px;
    }

    .month-selector button {
      background: none;
      border: none;
      color: var(--gray-700);
      padding: 8px 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .month-selector button:active {
      background: var(--gray-100);
    }

    .month-selector span {
      font-size: 17px;
      font-weight: 700;
      color: var(--gray-900);
      letter-spacing: -0.5px;
    }

    /* ìš”ì•½ ì¹´ë“œ */
    .summary {
      background: white;
      margin: 0;
      padding: 12px 8px;
      border-bottom: 1px solid var(--gray-100);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .summary-row {
      display: flex;
      justify-content: space-around;
      align-items: center;
    }

    .summary-item {
      text-align: center;
      flex: 1;
    }

    .summary-label {
      color: var(--gray-600);
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 14px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }

    .summary-value.income {
      color: var(--success);
    }

    .summary-value.expense {
      color: var(--danger);
    }

    .summary-value.balance {
      color: var(--gray-900);
    }

    /* ì½˜í…ì¸  ì˜ì—­ */
    .content {
      flex: 1;
      overflow-y: auto;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ë‹¬ë ¥ */
    .calendar {
      background: white;
      margin: 8px 0 0;
      padding: 16px 8px;
      border-bottom: 1px solid var(--gray-100);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .calendar-day-header {
      text-align: center;
      padding: 12px 0 8px;
      font-size: 13px;
      color: var(--gray-500);
      font-weight: 600;
    }

    .calendar-day-header.sun {
      color: var(--danger);
    }

    .calendar-day-header.sat {
      color: var(--primary);
    }

    .calendar-day {
      aspect-ratio: 1;
      border-radius: 8px;
      padding: 6px 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }

    .calendar-day:hover {
      background: var(--gray-50);
    }

    .calendar-day:active {
      background: var(--gray-100);
    }

    .calendar-day.other-month {
      opacity: 0.3;
    }

    .calendar-day.today {
      background: var(--primary);
      color: white;
    }

    .calendar-day.selected {
      background: var(--primary-dark);
      color: white;
    }

    .calendar-day.today .calendar-day-number,
    .calendar-day.selected .calendar-day-number {
      color: white;
    }

    .calendar-day.today .calendar-day-income,
    .calendar-day.today .calendar-day-expense,
    .calendar-day.selected .calendar-day-income,
    .calendar-day.selected .calendar-day-expense {
      color: white;
      opacity: 0.9;
    }

    .calendar-day-number {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
      color: var(--gray-900);
    }

    .calendar-day.sun .calendar-day-number {
      color: var(--danger);
    }

    .calendar-day.sat .calendar-day-number {
      color: var(--primary);
    }

    .calendar-day-income {
      font-size: 10px;
      font-weight: 600;
      color: var(--success);
      white-space: nowrap;
    }

    .calendar-day-expense {
      font-size: 10px;
      font-weight: 600;
      color: var(--danger);
      white-space: nowrap;
    }

    /* ë‹¬ë ¥ í•˜ë‹¨ ì„ íƒëœ ë‚ ì§œì˜ ê±°ë˜ ë‚´ì—­ */
    .calendar-selected-transactions {
      background: white;
      margin: 0;
      padding: 16px 8px;
      border-bottom: 1px solid var(--gray-100);
      min-height: 100px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .calendar-selected-date {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 12px;
      padding: 0 8px;
    }

    .calendar-transaction-list {
      max-height: 300px;
      overflow-y: auto;
    }

    /* ê±°ë˜ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ */
    .transaction-list {
      padding: 0 8px;
    }

    .transaction-date-group {
      margin-bottom: 24px;
    }

    .transaction-date-header {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-900);
      padding: 8px 0;
      margin-bottom: 8px;
    }

    .transaction-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: transform 0.2s;
      border: 1px solid var(--gray-100);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .transaction-item:active {
      transform: scale(0.98);
    }

    .transaction-left {
      flex: 1;
    }

    .transaction-user {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      background: var(--gray-100);
      color: var(--gray-700);
      padding: 3px 8px;
      border-radius: 4px;
      margin-right: 6px;
    }

    .transaction-category {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
      letter-spacing: -0.3px;
    }

    .transaction-method {
      font-size: 13px;
      color: var(--gray-500);
      margin-top: 4px;
      font-weight: 500;
    }

    .transaction-amount {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .transaction-amount.income {
      color: var(--success);
    }

    .transaction-amount.expense {
      color: var(--gray-900);
    }

    .transaction-amount.transfer {
      color: var(--warning);
    }

    /* ìì‚° ì¹´ë“œ */
    .asset-card {
      background: white;
      border-radius: 16px;
      padding: 24px 20px;
      margin: 0 8px 12px;
      border: 1px solid var(--gray-100);
    }

    .asset-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 8px;
    }

    .asset-balance {
      font-size: 32px;
      font-weight: 700;
      color: var(--gray-900);
      letter-spacing: -1px;
    }

    /* í†µê³„ ì°¨íŠ¸ */
    .chart {
      background: white;
      border-radius: 16px;
      padding: 24px 20px;
      margin: 0 8px 12px;
      border: 1px solid var(--gray-100);
    }

    .chart-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--gray-900);
    }

    .bar-chart {
      margin-bottom: 0;
    }

    .bar-item {
      margin-bottom: 16px;
    }

    .bar-item:last-child {
      margin-bottom: 0;
    }

    .bar-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .bar-label span:first-child {
      font-weight: 600;
      color: var(--gray-700);
    }

    .bar-label span:last-child {
      font-weight: 700;
      color: var(--gray-900);
    }

    .bar-bg {
      height: 8px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .bar-fill.warning {
      background: var(--warning);
    }

    .bar-fill.danger {
      background: var(--danger);
    }

    /* ëŒ€ì‹œë³´ë“œ */
    .dashboard {
      padding: 20px;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .summary-card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
    }

    .summary-card-label {
      font-size: 12px;
      color: var(--gray-600);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .summary-card-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .summary-card-value.income {
      color: var(--success);
    }

    .summary-card-value.expense {
      color: var(--danger);
    }

    .budget-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
      margin: 0 8px 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .budget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .budget-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .budget-amount {
      font-size: 14px;
      color: var(--gray-600);
    }

    .budget-progress {
      height: 12px;
      background: var(--gray-100);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .budget-progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 6px;
      transition: width 0.3s ease, background 0.3s ease;
    }

    .budget-progress-fill.warning {
      background: var(--warning);
    }

    .budget-progress-fill.danger {
      background: var(--danger);
    }

    .budget-percent {
      font-size: 13px;
      color: var(--gray-600);
      text-align: right;
    }

    /* ê²€ìƒ‰ë°” */
    .search-bar {
      margin: 12px 8px;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      font-size: 15px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* í•˜ë‹¨ íƒ­ë°” */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--gray-200);
      display: flex;
      padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
      z-index: 100;
      max-width: 480px;
      margin: 0 auto;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px 0;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--gray-500);
      transition: color 0.2s;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-icon {
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-icon svg {
      width: 24px;
      height: 24px;
    }

    .nav-label {
      font-size: 11px;
      font-weight: 600;
    }

    /* í”Œë¡œíŒ… ë²„íŠ¼ */
    .fab {
      position: fixed;
      bottom: calc(80px + env(safe-area-inset-bottom));
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(49, 130, 246, 0.4);
      cursor: pointer;
      z-index: 99;
      transition: all 0.2s;
    }

    .fab:active {
      transform: scale(0.9);
    }

    /* ëª¨ë‹¬ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
      animation: fadeIn 0.2s;
      overflow-x: hidden;
      overscroll-behavior-x: none;
    }

    .modal-overlay.active {
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal {
      background: white;
      border-radius: 20px 20px 0 0;
      padding: 24px 20px calc(24px + env(safe-area-inset-bottom));
      max-width: 480px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      overflow-x: hidden;
      overscroll-behavior-x: none;
      touch-action: pan-y;
      animation: slideUp 0.3s;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--gray-400);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* í¼ ìš”ì†Œ */
    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--gray-700);
      font-weight: 600;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      font-size: 16px;
      background: white;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
    }

    /* ê¸ˆì•¡ ì…ë ¥ ê°œì„  */
    .amount-input-wrapper {
      position: relative;
      display: flex;
      gap: 8px;
    }

    .amount-input-wrapper .form-input {
      flex: 1;
    }

    .reset-amount-btn {
      padding: 14px 20px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .reset-amount-btn:active {
      background: var(--gray-200);
    }

    /* ê¸ˆì•¡ ì…ë ¥ */
    .quick-amount-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .quick-amount-btn {
      padding: 12px;
      background: var(--gray-100);
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-amount-btn:active {
      background: var(--gray-200);
      transform: scale(0.95);
    }

    /* ì„ íƒ ê·¸ë¦¬ë“œ */
    .select-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .select-item {
      padding: 14px 12px;
      background: var(--gray-100);
      border: 1.5px solid var(--gray-200);
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-700);
      transition: all 0.2s;
    }

    .select-item:active {
      transform: scale(0.95);
    }

    .select-item.selected {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .expand-toggle {
      grid-column: 1 / -1;
      padding: 12px;
      background: none;
      border: none;
      color: var(--primary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
    }

    /* ë²„íŠ¼ */
    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:active {
      background: var(--primary-dark);
      transform: scale(0.98);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .btn-secondary:active {
      background: var(--gray-200);
      transform: scale(0.98);
    }

    /* í•„í„° ë²„íŠ¼ ê·¸ë£¹ */
    .filter-buttons {
      display: flex;
      gap: 8px;
      margin: 12px 8px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .filter-btn {
      padding: 8px 16px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      cursor: pointer;
      color: var(--gray-700);
      transition: all 0.2s;
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* ìì‚° ì´ë™ */
    .transfer-arrow {
      text-align: center;
      font-size: 24px;
      color: var(--gray-400);
      margin: 16px 0;
    }

    /* ì„¤ì • í˜ì´ì§€ */
    .settings-section {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin: 0 8px 12px;
      border: 1px solid var(--gray-100);
    }

    .settings-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--gray-900);
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-100);
    }

    .settings-item:last-child {
      border-bottom: none;
    }

    .settings-item-name {
      font-size: 15px;
      font-weight: 500;
      color: var(--gray-900);
    }

    .settings-item-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      background: var(--gray-100);
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .icon-btn:active {
      background: var(--gray-200);
      transform: scale(0.9);
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--gray-400);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 15px;
      font-weight: 500;
    }

    /* ì—°ê²° ìƒíƒœ í‘œì‹œ */
    .connection-status {
      padding: 12px 16px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      background: var(--gray-100);
      color: var(--gray-600);
      border-radius: 12px;
      margin: 0 8px 12px;
    }

    .connection-status.connected {
      background: #E8F5E9;
      color: var(--success);
    }

    .connection-status.local {
      background: #FFF3E0;
      color: var(--warning);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <!-- í—¤ë” -->
    <div class="header">
      <h1>ìƒí™œ ê°€ê³„ë¶€</h1>
      <div class="month-selector">
        <button id="prevMonth">â—€</button>
        <span id="currentMonth"></span>
        <button id="nextMonth">â–¶</button>
      </div>
    </div>

    <!-- ìš”ì•½ (í•œ ì¤„ë¡œ ì–‡ê²Œ) -->
    <div class="summary">
      <div class="summary-row">
        <div class="summary-item">
          <div class="summary-label">ìˆ˜ì…</div>
          <div class="summary-value income" id="totalIncome">0ì›</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">ì§€ì¶œ</div>
          <div class="summary-value expense" id="totalExpense">0ì›</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">ì”ì•¡</div>
          <div class="summary-value balance" id="totalBalance">0ì›</div>
        </div>
      </div>
    </div>

    <!-- ì½˜í…ì¸  -->
    <div class="content">
      <!-- ë‹¬ë ¥ íƒ­ -->
      <div class="tab-content active" id="calendar-content">
        <!-- ë‹¬ë ¥ -->
        <div class="calendar">
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <!-- ì„ íƒëœ ë‚ ì§œì˜ ê±°ë˜ ë‚´ì—­ -->
        <div class="calendar-selected-transactions" id="calendarSelectedTransactions">
          <div class="calendar-selected-date" id="calendarSelectedDate">ì˜¤ëŠ˜</div>
          <div class="calendar-transaction-list" id="calendarTransactionList">
            <div class="empty-state">
              <div class="empty-state-text">ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ê±°ë˜ ë‚´ì—­ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
            </div>
          </div>
        </div>

        <!-- ì›”ê°„ ì˜ˆì‚° ì¹´ë“œ -->
        <div class="budget-card" id="monthlyBudgetCard" style="display: none;">
          <div class="budget-header">
            <span class="budget-title">ì›”ê°„ ì˜ˆì‚°</span>
            <span class="budget-amount"><span id="budgetSpent">0ì›</span> / <span id="budgetTotal">0ì›</span></span>
          </div>
          <div class="budget-progress">
            <div class="budget-progress-fill" id="budgetProgressBar"></div>
          </div>
          <div class="budget-percent" id="budgetPercent">0%</div>
        </div>
      </div>

      <!-- ë‚´ì—­ íƒ­ -->
      <div class="tab-content" id="log-content">
        <div class="search-bar">
          <input type="text" class="search-input" id="searchInput" placeholder="ê±°ë˜ ë‚´ì—­ ê²€ìƒ‰ (ë©”ëª¨, ì¹´í…Œê³ ë¦¬ ë“±)">
        </div>
        <div class="filter-buttons" id="logFilters">
          <button class="filter-btn active" data-filter="all">ì „ì²´</button>
          <button class="filter-btn" data-filter="income">ìˆ˜ì…</button>
          <button class="filter-btn" data-filter="expense">ì§€ì¶œ</button>
          <button class="filter-btn" data-filter="transfer">ìì‚°ì´ë™</button>
        </div>
        <div id="transactionList"></div>
      </div>

      <!-- ìì‚° íƒ­ -->
      <div class="tab-content" id="assets-content">
        <div id="assetsList"></div>
        <div style="padding: 0 8px;">
          <button class="btn btn-secondary" id="transferAssetBtn">ìì‚° ì´ë™</button>
        </div>
      </div>

      <!-- í†µê³„ íƒ­ -->
      <div class="tab-content" id="stats-content">
        <div class="filter-buttons">
          <button class="filter-btn active" data-period="week">ì£¼ê°„</button>
          <button class="filter-btn" data-period="month">ì›”ê°„</button>
          <button class="filter-btn" data-period="year">ì—°ê°„</button>
        </div>
        <div id="statsCharts"></div>
      </div>

      <!-- ì„¤ì • íƒ­ -->
      <div class="tab-content" id="settings-content">
        <div class="connection-status local" id="connectionStatus">ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš© ì¤‘</div>

        <div class="settings-section">
          <div class="settings-title">ì˜ˆì‚° ì„¤ì •</div>
          <div class="form-group">
            <label class="form-label">ì›”ê°„ ì˜ˆì‚°</label>
            <input type="number" class="form-input" id="monthlyBudgetInput" placeholder="ì›”ê°„ ì˜ˆì‚° ì…ë ¥ (ì›)">
          </div>
          <button class="btn btn-primary" id="saveBudget">ì˜ˆì‚° ì €ì¥</button>
        </div>

        <div class="settings-section">
          <div class="settings-title">Supabase ì—°ê²°</div>
          <div class="form-group">
            <label class="form-label">Supabase URL</label>
            <input type="text" class="form-input" id="supabaseUrl" placeholder="https://xxx.supabase.co" value="https://zmnzfeicabvquwbxgjwt.supabase.co">
          </div>
          <div class="form-group">
            <label class="form-label">Supabase Key</label>
            <input type="password" class="form-input" id="supabaseKey" placeholder="anon key" value="sb_publishable_EUBiU6pKPHdimu-roGXrag_CK9rWVdm">
          </div>
          <button class="btn btn-primary" id="connectSupabase">ì—°ê²°í•˜ê¸°</button>
          <button class="btn btn-secondary" id="useLocal">ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš©</button>
          <button class="btn btn-secondary" id="syncData" style="display: none; margin-top: 8px;">
            ğŸ”„ ìˆ˜ë™ ë™ê¸°í™”
          </button>
          <div style="margin-top: 8px; font-size: 12px; color: #888; display: none;" id="autoSyncInfo">
            ğŸ’¡ ìë™ ë™ê¸°í™” í™œì„±í™”ë¨ (5ì´ˆ í›„ ìë™ ì €ì¥, ì•± ì—´ ë•Œ/íƒ­ ì „í™˜ ì‹œ ìë™ ë¡œë“œ)
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-title">ê²°ì œìˆ˜ë‹¨ ê´€ë¦¬</div>
          <div id="paymentMethodsList"></div>
          <button class="btn btn-secondary" id="addPaymentMethod">+ ê²°ì œìˆ˜ë‹¨ ì¶”ê°€</button>
        </div>

        <div class="settings-section">
          <div class="settings-title">ìì‚° ê´€ë¦¬</div>
          <div id="assetsSettingsList"></div>
          <button class="btn btn-secondary" id="addAsset">+ ìì‚° ì¶”ê°€</button>
        </div>

        <div class="settings-section">
          <div class="settings-title">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</div>
          <div id="categoriesList"></div>
          <button class="btn btn-secondary" id="addCategory">+ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
        </div>
      </div>
    </div>

    <!-- í•˜ë‹¨ íƒ­ë°” -->
    <nav class="bottom-nav">
      <button class="nav-item active" data-tab="calendar">
        <div class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </div>
        <div class="nav-label">ë‹¬ë ¥</div>
      </button>
      <button class="nav-item" data-tab="log">
        <div class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
        </div>
        <div class="nav-label">ë‚´ì—­</div>
      </button>
      <button class="nav-item" data-tab="assets">
        <div class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
        </div>
        <div class="nav-label">ìì‚°</div>
      </button>
      <button class="nav-item" data-tab="stats">
        <div class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
          </svg>
        </div>
        <div class="nav-label">í†µê³„</div>
      </button>
      <button class="nav-item" data-tab="settings">
        <div class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m0-18l-2.5 2.5M12 1l2.5 2.5M1 12h6m6 0h6m-18 0l2.5-2.5M1 12l2.5 2.5M12 23l-2.5-2.5M12 23l2.5-2.5M23 12l-2.5-2.5M23 12l-2.5 2.5"></path>
          </svg>
        </div>
        <div class="nav-label">ì„¤ì •</div>
      </button>
    </nav>

    <!-- í”Œë¡œíŒ… ë²„íŠ¼ -->
    <button class="fab" id="addTransactionBtn">+</button>
  </div>

  <!-- ê±°ë˜ ì¶”ê°€ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="transactionModal">
    <div class="modal" id="transactionModalContent">
      <div class="modal-header">
        <h2 class="modal-title">ê±°ë˜ ì¶”ê°€</h2>
        <button class="modal-close" onclick="closeModal('transactionModal')">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label">ì‚¬ìš©ì</label>
        <div class="select-grid" id="userSelect"></div>
      </div>

      <div class="form-group">
        <label class="form-label">ìœ í˜•</label>
        <div class="select-grid">
          <div class="select-item selected" data-type="expense">ì§€ì¶œ</div>
          <div class="select-item" data-type="income">ìˆ˜ì…</div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ê¸ˆì•¡</label>
        <div class="amount-input-wrapper">
          <input type="text" inputmode="numeric" class="form-input" id="amountInput" placeholder="ê¸ˆì•¡ ì…ë ¥">
          <button class="reset-amount-btn" id="resetAmountBtn">ì´ˆê¸°í™”</button>
        </div>
        <div class="quick-amount-buttons">
          <button class="quick-amount-btn" data-amount="100000">+10ë§Œ</button>
          <button class="quick-amount-btn" data-amount="10000">+1ë§Œ</button>
          <button class="quick-amount-btn" data-amount="1000">+1ì²œ</button>
          <button class="quick-amount-btn" data-amount="100">+1ë°±</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
        <div class="select-grid" id="categorySelect"></div>
      </div>

      <div class="form-group">
        <label class="form-label">ê²°ì œìˆ˜ë‹¨</label>
        <div class="select-grid" id="paymentMethodSelect"></div>
      </div>

      <div class="form-group">
        <label class="form-label">ìì‚°</label>
        <div class="select-grid" id="assetSelect"></div>
      </div>

      <div class="form-group">
        <label class="form-label">ë‚ ì§œ</label>
        <input type="date" class="form-input" id="dateInput">
      </div>

      <div class="form-group">
        <label class="form-label">ë©”ëª¨ (ì„ íƒ)</label>
        <input type="text" class="form-input" id="memoInput" placeholder="ë©”ëª¨">
      </div>

      <button class="btn btn-primary" id="saveTransaction">ì €ì¥</button>
    </div>
  </div>

  <!-- ìì‚° ì´ë™ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="transferModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ìì‚° ì´ë™</h2>
        <button class="modal-close" onclick="closeModal('transferModal')">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label">ì¶œë°œ ìì‚°</label>
        <div class="select-grid" id="fromAssetSelect"></div>
      </div>

      <div class="transfer-arrow">â†“</div>

      <div class="form-group">
        <label class="form-label">ë„ì°© ìì‚°</label>
        <div class="select-grid" id="toAssetSelect"></div>
      </div>

      <div class="form-group">
        <label class="form-label">ê¸ˆì•¡</label>
        <div class="amount-input-wrapper">
          <input type="text" inputmode="numeric" class="form-input" id="transferAmountInput" placeholder="ì´ë™í•  ê¸ˆì•¡">
          <button class="reset-amount-btn" id="resetTransferAmountBtn">ì´ˆê¸°í™”</button>
        </div>
        <div class="quick-amount-buttons">
          <button class="quick-amount-btn" data-target="transfer" data-amount="100000">+10ë§Œ</button>
          <button class="quick-amount-btn" data-target="transfer" data-amount="10000">+1ë§Œ</button>
          <button class="quick-amount-btn" data-target="transfer" data-amount="1000">+1ì²œ</button>
          <button class="quick-amount-btn" data-target="transfer" data-amount="100">+1ë°±</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ë‚ ì§œ</label>
        <input type="date" class="form-input" id="transferDateInput">
      </div>

      <button class="btn btn-primary" id="saveTransfer">ì´ë™í•˜ê¸°</button>
    </div>
  </div>

  <script>
    // ============================================
    // ì „ì—­ ìƒíƒœ
    // ============================================
    let state = {
      currentDate: new Date(),
      selectedDate: formatDate(new Date()), // ì„ íƒëœ ë‚ ì§œ ì¶”ê°€
      selectedUser: null,
      selectedType: 'expense',
      selectedCategory: null,
      selectedPaymentMethod: null,
      selectedAsset: null,
      selectedFromAsset: null,
      selectedToAsset: null,
      logFilter: 'all',

      users: [
        { id: '1', name: 'êµ­í™˜' },
        { id: '2', name: 'í˜œì§€' }
      ],

      paymentMethods: [
        { id: '1', name: 'í˜„ê¸ˆ', displayOrder: 1, isFavorite: true },
        { id: '2', name: 'ì²´í¬ì¹´ë“œ', displayOrder: 2, isFavorite: true },
        { id: '3', name: 'ì‹ ìš©ì¹´ë“œ1', displayOrder: 3, isFavorite: true },
        { id: '4', name: 'ì‹ ìš©ì¹´ë“œ2', displayOrder: 4, isFavorite: true }
      ],

      assets: [
        { id: '1', name: 'ì…ì¶œê¸ˆ í†µì¥', balance: 0, displayOrder: 1, isFavorite: true },
        { id: '2', name: 'ìë™ì°¨ í†µì¥', balance: 0, displayOrder: 2, isFavorite: true },
        { id: '3', name: 'ìƒí™œë¹„ í†µì¥', balance: 0, displayOrder: 3, isFavorite: true }
      ],

      categories: [
        { id: '1', name: 'ê¸‰ì—¬', icon: 'ğŸ’°', type: 'income', displayOrder: 1, isFavorite: true },
        { id: '2', name: 'ë¶€ìˆ˜ì…', icon: 'ğŸ’µ', type: 'income', displayOrder: 2, isFavorite: true },
        { id: '3', name: 'ì‹ë¹„', icon: 'ğŸš', type: 'expense', displayOrder: 1, isFavorite: true },
        { id: '4', name: 'ì¹´í˜', icon: 'â˜•', type: 'expense', displayOrder: 2, isFavorite: true },
        { id: '5', name: 'êµí†µ', icon: 'ğŸšŒ', type: 'expense', displayOrder: 3, isFavorite: true },
        { id: '6', name: 'ì‡¼í•‘', icon: 'ğŸ›’', type: 'expense', displayOrder: 4, isFavorite: true },
        { id: '7', name: 'ìƒí™œ', icon: 'ğŸ ', type: 'expense', displayOrder: 5, isFavorite: false },
        { id: '8', name: 'ì·¨ë¯¸', icon: 'ğŸ®', type: 'expense', displayOrder: 6, isFavorite: false },
        { id: '9', name: 'ì˜ë£Œ', icon: 'ğŸ¥', type: 'expense', displayOrder: 7, isFavorite: false },
        { id: '10', name: 'ê²½ì¡°ì‚¬', icon: 'ğŸ', type: 'expense', displayOrder: 8, isFavorite: false },
        { id: '11', name: 'ë¯¸ìš©', icon: 'ğŸ’‡', type: 'expense', displayOrder: 9, isFavorite: false },
        { id: '12', name: 'ê¸°íƒ€', icon: 'ğŸ“¦', type: 'expense', displayOrder: 10, isFavorite: false }
      ],

      transactions: [],

      // ì˜ˆì‚° ì„¤ì •
      monthlyBudget: 0, // ì›”ê°„ ì „ì²´ ì˜ˆì‚°
      categoryBudgets: {}, // ì¹´í…Œê³ ë¦¬ë³„ ì˜ˆì‚° { categoryId: amount }

      // ê³ ì • ê±°ë˜
      recurringTransactions: [], // { id, type, userId, amount, categoryId, paymentMethodId, assetId, memo, dayOfMonth, isActive }

      // í•„í„° ë° ê²€ìƒ‰
      statsFilter: 'month', // 'week', 'month', 'year'
      searchQuery: '',

      expandedSections: {
        category: false,
        paymentMethod: false
      },

      useLocalStorage: true,
      supabaseClient: null
    };

    // ============================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ============================================

    // ìˆ«ìì— ì²œ ë‹¨ìœ„ ì‰¼í‘œ ì¶”ê°€
    function formatNumber(num) {
      const numStr = String(num).replace(/[^\d]/g, '');
      if (!numStr) return '';
      return new Intl.NumberFormat('ko-KR').format(parseInt(numStr));
    }

    // ì‰¼í‘œê°€ í¬í•¨ëœ ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜
    function parseFormattedNumber(str) {
      return parseInt(String(str).replace(/[^\d]/g, '')) || 0;
    }

    // Debounce í•¨ìˆ˜ (ì—°ì† í˜¸ì¶œ ë°©ì§€)
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function formatMoney(amount) {
      return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
    }

    function formatMoneyShort(amount) {
      if (amount >= 10000) {
        return (amount / 10000).toFixed(1) + 'ë§Œ';
      }
      return new Intl.NumberFormat('ko-KR').format(amount);
    }

    function formatDate(date) {
      const d = new Date(date);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    function formatDateKo(date) {
      const d = new Date(date);
      const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      return `${d.getMonth() + 1}ì›” ${d.getDate()}ì¼ (${days[d.getDay()]})`;
    }

    function getMonthRange(date) {
      const start = new Date(date.getFullYear(), date.getMonth(), 1);
      const end = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      return { start, end };
    }

    function getWeekRange(date) {
      const start = new Date(date);
      start.setDate(date.getDate() - date.getDay()); // ì´ë²ˆ ì£¼ ì¼ìš”ì¼
      const end = new Date(start);
      end.setDate(start.getDate() + 6); // ì´ë²ˆ ì£¼ í† ìš”ì¼
      return { start, end };
    }

    function getYearRange(date) {
      const start = new Date(date.getFullYear(), 0, 1);
      const end = new Date(date.getFullYear(), 11, 31);
      return { start, end };
    }

    function getStatsPeriodRange() {
      if (state.statsFilter === 'week') {
        return getWeekRange(state.currentDate);
      } else if (state.statsFilter === 'year') {
        return getYearRange(state.currentDate);
      } else {
        return getMonthRange(state.currentDate);
      }
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // ============================================
    // ë°ì´í„° ì €ì¥/ë¡œë“œ
    // ============================================

    // ë¡œì»¬ ì €ì¥ì€ í•­ìƒ ì¦‰ì‹œ ì‹¤í–‰ (ë¹ ë¥¸ ë°˜ì‘ì†ë„)
    function saveLocalData() {
      localStorage.setItem('household_data', JSON.stringify({
        users: state.users,
        paymentMethods: state.paymentMethods,
        assets: state.assets,
        categories: state.categories,
        transactions: state.transactions,
        monthlyBudget: state.monthlyBudget,
        categoryBudgets: state.categoryBudgets
      }));
    }

    // Supabase ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
    async function saveToSupabase() {
      if (!state.supabaseClient) return;

      try {
        const data = {
          users: state.users,
          payment_methods: state.paymentMethods,
          assets: state.assets,
          categories: state.categories,
          transactions: state.transactions,
          monthly_budget: state.monthlyBudget,
          category_budgets: state.categoryBudgets,
          updated_at: new Date().toISOString()
        };

        // ê¸°ì¡´ ë°ì´í„° í™•ì¸
        const { data: existing, error: selectError } = await state.supabaseClient
          .from('household_data')
          .select('id')
          .limit(1);

        if (selectError) {
          console.error('Supabase ì¡°íšŒ ì‹¤íŒ¨:', selectError);
          return;
        }

        if (existing && existing.length > 0) {
          // ì—…ë°ì´íŠ¸
          const { error: updateError } = await state.supabaseClient
            .from('household_data')
            .update(data)
            .eq('id', existing[0].id);

          if (updateError) {
            console.error('Supabase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updateError);
          } else {
            console.log('âœ… Supabase ìë™ ì €ì¥ ì™„ë£Œ (ì—…ë°ì´íŠ¸)');
          }
        } else {
          // ì‚½ì…
          const { error: insertError } = await state.supabaseClient
            .from('household_data')
            .insert([data]);

          if (insertError) {
            console.error('Supabase ì‚½ì… ì‹¤íŒ¨:', insertError);
          } else {
            console.log('âœ… Supabase ìë™ ì €ì¥ ì™„ë£Œ (ì‹ ê·œ)');
          }
        }
      } catch (error) {
        console.error('Supabase ì €ì¥ ì‹¤íŒ¨:', error);
      }
    }

    // Debounced ìë™ ë™ê¸°í™” (5ì´ˆ í›„ ì‹¤í–‰)
    const debouncedSyncToSupabase = debounce(saveToSupabase, 5000);

    // ë°ì´í„° ì €ì¥ (ë¡œì»¬ ì¦‰ì‹œ + Supabase ìë™)
    function saveData() {
      saveLocalData(); // ì¦‰ì‹œ ë¡œì»¬ ì €ì¥

      // Supabase ì—°ê²° ì‹œ ìë™ ë™ê¸°í™” (debounced)
      if (!state.useLocalStorage && state.supabaseClient) {
        debouncedSyncToSupabase();
      }
    }

    // ë¡œì»¬ ë°ì´í„° ë¡œë“œ
    function loadLocalData() {
      const saved = localStorage.getItem('household_data');
      if (saved) {
        const data = JSON.parse(saved);
        state.users = data.users || state.users;
        state.paymentMethods = data.paymentMethods || state.paymentMethods;
        state.assets = data.assets || state.assets;
        state.categories = data.categories || state.categories;
        state.transactions = data.transactions || [];
        state.monthlyBudget = data.monthlyBudget || 0;
        state.categoryBudgets = data.categoryBudgets || {};
      }
    }

    // Supabase ë°ì´í„° ë¡œë“œ
    async function loadFromSupabase() {
      if (!state.supabaseClient) return;

      try {
        const { data, error } = await state.supabaseClient
          .from('household_data')
          .select('*')
          .order('updated_at', { ascending: false })
          .limit(1);

        if (error) {
          console.error('Supabase ë¡œë“œ ì‹¤íŒ¨:', error);
          return;
        }

        if (data && data.length > 0) {
          const loadedData = data[0];
          state.users = loadedData.users || state.users;
          state.paymentMethods = loadedData.payment_methods || state.paymentMethods;
          state.assets = loadedData.assets || state.assets;
          state.categories = loadedData.categories || state.categories;
          state.transactions = loadedData.transactions || [];
          state.monthlyBudget = loadedData.monthly_budget || 0;
          state.categoryBudgets = loadedData.category_budgets || {};

          // ë¡œì»¬ì—ë„ ì €ì¥
          saveLocalData();
          console.log('âœ… Supabase ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
        } else {
          console.log('â„¹ï¸ Supabaseì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        }
      } catch (error) {
        console.error('Supabase ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // ë°ì´í„° ë¡œë“œ (ë¡œì»¬ ìš°ì„ , Supabase ìˆìœ¼ë©´ ê°€ì ¸ì˜¤ê¸°)
    async function loadData() {
      loadLocalData(); // ì¦‰ì‹œ ë¡œì»¬ ë¡œë“œ

      // Supabase ì—°ê²° ì‹œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      if (!state.useLocalStorage && state.supabaseClient) {
        await loadFromSupabase();
      }
    }

    // ============================================
    // ë Œë”ë§ í•¨ìˆ˜
    // ============================================
    function updateMonthDisplay() {
      const month = state.currentDate.getMonth() + 1;
      const year = state.currentDate.getFullYear();
      document.getElementById('currentMonth').textContent = `${year}ë…„ ${month}ì›”`;
    }

    function updateSummary() {
      const { start, end } = getMonthRange(state.currentDate);
      const monthTransactions = state.transactions.filter(t => {
        const tDate = new Date(t.transactionDate);
        return tDate >= start && tDate <= end;
      });

      const income = monthTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);

      const expense = monthTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);

      const balance = income - expense;

      document.getElementById('totalIncome').textContent = formatMoney(income);
      document.getElementById('totalExpense').textContent = formatMoney(expense);
      document.getElementById('totalBalance').textContent = formatMoney(balance);

      // ì˜ˆì‚° ì§„í–‰ë¥ 
      if (state.monthlyBudget > 0) {
        document.getElementById('monthlyBudgetCard').style.display = 'block';
        document.getElementById('budgetSpent').textContent = formatMoney(expense);
        document.getElementById('budgetTotal').textContent = formatMoney(state.monthlyBudget);

        const percent = Math.min((expense / state.monthlyBudget) * 100, 100);
        document.getElementById('budgetPercent').textContent = `${percent.toFixed(1)}%`;

        const progressBar = document.getElementById('budgetProgressBar');
        progressBar.style.width = `${percent}%`;

        progressBar.classList.remove('warning', 'danger');
        if (percent >= 100) {
          progressBar.classList.add('danger');
        } else if (percent >= 80) {
          progressBar.classList.add('warning');
        }
      } else {
        document.getElementById('monthlyBudgetCard').style.display = 'none';
      }
    }

    function renderDashboard() {
      const { start, end } = getMonthRange(state.currentDate);
      const monthTransactions = state.transactions.filter(t => {
        const tDate = new Date(t.transactionDate);
        return tDate >= start && tDate <= end;
      });

      const income = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
      const expense = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
      const balance = income - expense;

      document.getElementById('monthIncome').textContent = formatMoney(income);
      document.getElementById('monthExpense').textContent = formatMoney(expense);
      document.getElementById('monthBalance').textContent = formatMoney(balance);

      // ì˜ˆì‚° ì§„í–‰ë¥ 
      if (state.monthlyBudget > 0) {
        document.getElementById('monthlyBudgetCard').style.display = 'block';
        document.getElementById('budgetSpent').textContent = formatMoney(expense);
        document.getElementById('budgetTotal').textContent = formatMoney(state.monthlyBudget);

        const percent = Math.min((expense / state.monthlyBudget) * 100, 100);
        document.getElementById('budgetPercent').textContent = `${percent.toFixed(1)}%`;

        const progressBar = document.getElementById('budgetProgressBar');
        progressBar.style.width = `${percent}%`;

        // ìƒ‰ìƒ ë³€ê²½ (80% ì´ìƒ ì£¼ì˜, 100% ì´ìƒ ìœ„í—˜)
        progressBar.classList.remove('warning', 'danger');
        if (percent >= 100) {
          progressBar.classList.add('danger');
        } else if (percent >= 80) {
          progressBar.classList.add('warning');
        }
      } else {
        document.getElementById('monthlyBudgetCard').style.display = 'none';
      }
    }

    function renderCalendar() {
      const year = state.currentDate.getFullYear();
      const month = state.currentDate.getMonth();

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      const startDay = new Date(firstDay);
      startDay.setDate(startDay.getDate() - firstDay.getDay());

      const endDay = new Date(lastDay);
      endDay.setDate(endDay.getDate() + (6 - lastDay.getDay()));

      let html = '';

      const dayHeaders = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      dayHeaders.forEach((day, index) => {
        let className = 'calendar-day-header';
        if (index === 0) className += ' sun';
        if (index === 6) className += ' sat';
        html += `<div class="${className}">${day}</div>`;
      });

      const current = new Date(startDay);
      const todayStr = formatDate(new Date());

      while (current <= endDay) {
        const dateStr = formatDate(current);
        const isCurrentMonth = current.getMonth() === month;
        const isToday = todayStr === dateStr;
        const isSelected = state.selectedDate === dateStr;
        const dayOfWeek = current.getDay();

        const dayTransactions = state.transactions.filter(t => t.transactionDate === dateStr);
        const income = dayTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const expense = dayTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

        let className = 'calendar-day';
        if (!isCurrentMonth) className += ' other-month';
        if (isToday) className += ' today';
        if (isSelected) className += ' selected';
        if (dayOfWeek === 0) className += ' sun';
        if (dayOfWeek === 6) className += ' sat';

        html += `
          <div class="${className}" onclick="onCalendarDayClick('${dateStr}')" ondblclick="onCalendarDayDoubleClick('${dateStr}')">
            <div class="calendar-day-number">${current.getDate()}</div>
            ${income > 0 ? `<div class="calendar-day-income">+${formatMoneyShort(income)}</div>` : ''}
            ${expense > 0 ? `<div class="calendar-day-expense">-${formatMoneyShort(expense)}</div>` : ''}
          </div>
        `;

        current.setDate(current.getDate() + 1);
      }

      document.getElementById('calendarGrid').innerHTML = html;
    }

    function onCalendarDayClick(dateStr) {
      state.selectedDate = dateStr;
      renderCalendar();
      renderSelectedDateTransactions(dateStr);
    }

    function onCalendarDayDoubleClick(dateStr) {
      openTransactionModal();
      document.getElementById('dateInput').value = dateStr;
    }

    function renderSelectedDateTransactions(dateStr) {
      const dayTransactions = state.transactions.filter(t => t.transactionDate === dateStr);

      document.getElementById('calendarSelectedDate').textContent = formatDateKo(dateStr);

      if (dayTransactions.length === 0) {
        document.getElementById('calendarTransactionList').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-text">ì´ ë‚ ì§œì— ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        `;
        return;
      }

      let html = dayTransactions.map(t => renderTransactionItem(t)).join('');
      document.getElementById('calendarTransactionList').innerHTML = html;
    }

    function renderTransactionList() {
      const { start, end } = getMonthRange(state.currentDate);
      let transactions = state.transactions.filter(t => {
        const tDate = new Date(t.transactionDate);
        return tDate >= start && tDate <= end;
      });

      // í•„í„° ì ìš©
      if (state.logFilter !== 'all') {
        transactions = transactions.filter(t => t.type === state.logFilter);
      }

      // ê²€ìƒ‰ ì ìš©
      if (state.searchQuery) {
        const query = state.searchQuery.toLowerCase();
        transactions = transactions.filter(t => {
          const category = state.categories.find(c => c.id === t.categoryId);
          const paymentMethod = state.paymentMethods.find(p => p.id === t.paymentMethodId);
          const user = state.users.find(u => u.id === t.userId);

          return (
            (t.memo && t.memo.toLowerCase().includes(query)) ||
            (category && category.name.toLowerCase().includes(query)) ||
            (paymentMethod && paymentMethod.name.toLowerCase().includes(query)) ||
            (user && user.name.toLowerCase().includes(query))
          );
        });
      }

      // ë‚ ì§œë³„ ê·¸ë£¹í™”
      const grouped = {};
      transactions.forEach(t => {
        const dateKey = t.transactionDate;
        if (!grouped[dateKey]) grouped[dateKey] = [];
        grouped[dateKey].push(t);
      });

      // ì •ë ¬ (ìµœì‹ ìˆœ)
      const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

      let html = '';
      if (sortedDates.length === 0) {
        html = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div class="empty-state-text">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>';
      } else {
        sortedDates.forEach(dateKey => {
          const items = grouped[dateKey];
          html += `
            <div class="transaction-date-group">
              <div class="transaction-date-header">${formatDateKo(dateKey)}</div>
              ${items.map(t => renderTransactionItem(t)).join('')}
            </div>
          `;
        });
      }

      document.getElementById('transactionList').innerHTML = html;
    }

    function renderTransactionItem(t) {
      const user = state.users.find(u => u.id === t.userId);
      const category = state.categories.find(c => c.id === t.categoryId);
      const paymentMethod = state.paymentMethods.find(p => p.id === t.paymentMethodId);
      const asset = state.assets.find(a => a.id === t.assetId);
      const toAsset = t.toAssetId ? state.assets.find(a => a.id === t.toAssetId) : null;

      let methodText = '';
      if (t.type === 'transfer') {
        methodText = `${asset?.name || ''} â†’ ${toAsset?.name || ''}`;
      } else {
        methodText = `${paymentMethod?.name || ''} Â· ${asset?.name || ''}`;
      }

      const amountClass = t.type === 'income' ? 'income' : (t.type === 'expense' ? 'expense' : 'transfer');
      const amountPrefix = t.type === 'income' ? '+' : (t.type === 'expense' ? '-' : '');

      const categoryDisplay = category ? (category.icon ? `${category.icon} ${category.name}` : category.name) : (t.type === 'transfer' ? 'ìì‚°ì´ë™' : '');

      return `
        <div class="transaction-item">
          <div class="transaction-left">
            ${user ? `<span class="transaction-user">${user.name}</span>` : ''}
            <span class="transaction-category">${categoryDisplay}</span>
            ${methodText ? `<div class="transaction-method">${methodText}</div>` : ''}
            ${t.memo ? `<div class="transaction-method">${t.memo}</div>` : ''}
          </div>
          <div class="transaction-amount ${amountClass}">
            ${amountPrefix}${formatMoney(t.amount)}
          </div>
        </div>
      `;
    }

    function renderAssetsList() {
      const sortedAssets = [...state.assets].sort((a, b) => a.displayOrder - b.displayOrder);

      let html = sortedAssets.map(asset => {
        // ìì‚°ë³„ ì”ì•¡ ê³„ì‚°
        const balance = calculateAssetBalance(asset.id);

        return `
          <div class="asset-card">
            <div class="asset-name">${asset.name}</div>
            <div class="asset-balance">${formatMoney(balance)}</div>
          </div>
        `;
      }).join('');

      document.getElementById('assetsList').innerHTML = html;
    }

    function calculateAssetBalance(assetId) {
      let balance = 0;

      state.transactions.forEach(t => {
        if (t.assetId === assetId) {
          if (t.type === 'income') {
            balance += t.amount;
          } else if (t.type === 'expense') {
            balance -= t.amount;
          } else if (t.type === 'transfer') {
            // ì¶œë°œ ìì‚°
            balance -= t.amount;
          }
        }

        // ë„ì°© ìì‚° (ì´ì²´ ë°›ì€ ê²½ìš°)
        if (t.type === 'transfer' && t.toAssetId === assetId) {
          balance += t.amount;
        }
      });

      return balance;
    }

    function renderStats() {
      const { start, end } = getStatsPeriodRange();
      const monthTransactions = state.transactions.filter(t => {
        const tDate = new Date(t.transactionDate);
        return tDate >= start && tDate <= end && t.type === 'expense';
      });

      let html = '';

      // ì‚¬ìš©ìë³„ ì§€ì¶œ
      const userExpenses = {};
      state.users.forEach(u => {
        userExpenses[u.id] = monthTransactions
          .filter(t => t.userId === u.id)
          .reduce((sum, t) => sum + t.amount, 0);
      });

      const maxUserExpense = Math.max(...Object.values(userExpenses), 1);

      html += '<div class="chart"><div class="chart-title">ì‚¬ìš©ìë³„ ì§€ì¶œ</div><div class="bar-chart">';
      state.users.forEach(user => {
        const amount = userExpenses[user.id] || 0;
        const percent = (amount / maxUserExpense) * 100;
        html += `
          <div class="bar-item">
            <div class="bar-label">
              <span>${user.name}</span>
              <span>${formatMoney(amount)}</span>
            </div>
            <div class="bar-bg">
              <div class="bar-fill" style="width: ${percent}%"></div>
            </div>
          </div>
        `;
      });
      html += '</div></div>';

      // ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ
      const categoryExpenses = {};
      monthTransactions.forEach(t => {
        if (!categoryExpenses[t.categoryId]) categoryExpenses[t.categoryId] = 0;
        categoryExpenses[t.categoryId] += t.amount;
      });

      const sortedCategories = Object.entries(categoryExpenses)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      if (sortedCategories.length > 0) {
        const maxCategoryExpense = sortedCategories[0][1];
        html += '<div class="chart"><div class="chart-title">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</div><div class="bar-chart">';
        sortedCategories.forEach(([catId, amount]) => {
          const category = state.categories.find(c => c.id === catId);
          const percent = (amount / maxCategoryExpense) * 100;
          const categoryDisplay = category ? (category.icon ? `${category.icon} ${category.name}` : category.name) : 'ê¸°íƒ€';
          html += `
            <div class="bar-item">
              <div class="bar-label">
                <span>${categoryDisplay}</span>
                <span>${formatMoney(amount)}</span>
              </div>
              <div class="bar-bg">
                <div class="bar-fill" style="width: ${percent}%"></div>
              </div>
            </div>
          `;
        });
        html += '</div></div>';
      }

      // ê²°ì œìˆ˜ë‹¨ë³„ ì§€ì¶œ
      const methodExpenses = {};
      monthTransactions.forEach(t => {
        if (!methodExpenses[t.paymentMethodId]) methodExpenses[t.paymentMethodId] = 0;
        methodExpenses[t.paymentMethodId] += t.amount;
      });

      const sortedMethods = Object.entries(methodExpenses)
        .sort((a, b) => b[1] - a[1]);

      if (sortedMethods.length > 0) {
        const maxMethodExpense = sortedMethods[0][1];
        html += '<div class="chart"><div class="chart-title">ê²°ì œìˆ˜ë‹¨ë³„ ì§€ì¶œ</div><div class="bar-chart">';
        sortedMethods.forEach(([methodId, amount]) => {
          const method = state.paymentMethods.find(m => m.id === methodId);
          const percent = (amount / maxMethodExpense) * 100;

          // ì‚¬ìš©ìë³„ ê¸ˆì•¡
          const userAmounts = state.users.map(u => {
            const userAmount = monthTransactions
              .filter(t => t.paymentMethodId === methodId && t.userId === u.id)
              .reduce((sum, t) => sum + t.amount, 0);
            return `${u.name}: ${formatMoney(userAmount)}`;
          }).join(' / ');

          html += `
            <div class="bar-item">
              <div class="bar-label">
                <span>${method?.name || 'ê¸°íƒ€'}</span>
                <span>${formatMoney(amount)}</span>
              </div>
              <div class="bar-bg">
                <div class="bar-fill" style="width: ${percent}%"></div>
              </div>
              <div style="font-size: 12px; color: var(--gray-500); margin-top: 6px; font-weight: 500;">${userAmounts}</div>
            </div>
          `;
        });
        html += '</div></div>';
      }

      // ì›”ë³„ íŠ¸ë Œë“œ (ìµœê·¼ 6ê°œì›”, ì›”ê°„ í•„í„°ì¼ ë•Œë§Œ í‘œì‹œ)
      if (state.statsFilter === 'month') {
        const monthlyTrend = [];
        for (let i = 5; i >= 0; i--) {
          const trendDate = new Date(state.currentDate);
          trendDate.setMonth(trendDate.getMonth() - i);
          const { start, end } = getMonthRange(trendDate);

          const trendTransactions = state.transactions.filter(t => {
            const tDate = new Date(t.transactionDate);
            return tDate >= start && tDate <= end;
          });

          const income = trendTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
          const expense = trendTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

          monthlyTrend.push({
            month: `${trendDate.getMonth() + 1}ì›”`,
            income,
            expense
          });
        }

        const maxTrendAmount = Math.max(
          ...monthlyTrend.map(m => Math.max(m.income, m.expense)),
          1
        );

        html += '<div class="chart"><div class="chart-title">ì›”ë³„ íŠ¸ë Œë“œ (ìµœê·¼ 6ê°œì›”)</div><div class="bar-chart">';
        monthlyTrend.forEach(data => {
          const incomePercent = (data.income / maxTrendAmount) * 100;
          const expensePercent = (data.expense / maxTrendAmount) * 100;

          html += `
            <div class="bar-item">
              <div class="bar-label">
                <span>${data.month}</span>
                <span>ìˆ˜ì… ${formatMoneyShort(data.income)} / ì§€ì¶œ ${formatMoneyShort(data.expense)}</span>
              </div>
              <div class="bar-bg" style="margin-bottom: 4px;">
                <div class="bar-fill" style="width: ${incomePercent}%; background: var(--success);"></div>
              </div>
              <div class="bar-bg">
                <div class="bar-fill" style="width: ${expensePercent}%; background: var(--danger);"></div>
              </div>
            </div>
          `;
        });
        html += '</div></div>';
      }

      document.getElementById('statsCharts').innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div class="empty-state-text">í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>';
    }

    function renderSelectGrid(containerId, items, selectedId, onClick, allowExpand = false) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const isExpanded = state.expandedSections[containerId];
      const displayItems = (allowExpand && !isExpanded)
        ? items.filter(item => item.isFavorite)
        : items;

      let html = displayItems.map(item => {
        const selected = item.id === selectedId ? 'selected' : '';
        const displayName = item.icon ? `${item.icon} ${item.name}` : item.name;
        return `<div class="select-item ${selected}" onclick="selectItem('${containerId}', '${item.id}')">${displayName}</div>`;
      }).join('');

      if (allowExpand && items.length > displayItems.length) {
        html += `<button class="expand-toggle" onclick="toggleExpand('${containerId}')">
          ${isExpanded ? 'ì ‘ê¸° â–²' : `ë”ë³´ê¸° (${items.length - displayItems.length}ê°œ) â–¼`}
        </button>`;
      }

      container.innerHTML = html;
    }

    function renderPaymentMethodsSettings() {
      const sorted = [...state.paymentMethods].sort((a, b) => a.displayOrder - b.displayOrder);
      const html = sorted.map(method => `
        <div class="settings-item">
          <span class="settings-item-name">${method.name}</span>
          <div class="settings-item-actions">
            <button class="icon-btn" onclick="moveItem('paymentMethods', '${method.id}', -1)">â†‘</button>
            <button class="icon-btn" onclick="moveItem('paymentMethods', '${method.id}', 1)">â†“</button>
            <button class="icon-btn" onclick="toggleFavorite('paymentMethods', '${method.id}')">${method.isFavorite ? 'â­' : 'â˜†'}</button>
            <button class="icon-btn" onclick="editItem('paymentMethods', '${method.id}')">âœï¸</button>
            <button class="icon-btn" onclick="deleteItem('paymentMethods', '${method.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');
      document.getElementById('paymentMethodsList').innerHTML = html;
    }

    function renderAssetsSettings() {
      const sorted = [...state.assets].sort((a, b) => a.displayOrder - b.displayOrder);
      const html = sorted.map(asset => `
        <div class="settings-item">
          <span class="settings-item-name">${asset.name}</span>
          <div class="settings-item-actions">
            <button class="icon-btn" onclick="moveItem('assets', '${asset.id}', -1)">â†‘</button>
            <button class="icon-btn" onclick="moveItem('assets', '${asset.id}', 1)">â†“</button>
            <button class="icon-btn" onclick="toggleFavorite('assets', '${asset.id}')">${asset.isFavorite ? 'â­' : 'â˜†'}</button>
            <button class="icon-btn" onclick="editItem('assets', '${asset.id}')">âœï¸</button>
            <button class="icon-btn" onclick="deleteItem('assets', '${asset.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');
      document.getElementById('assetsSettingsList').innerHTML = html;
    }

    function renderCategoriesSettings() {
      const sorted = [...state.categories].sort((a, b) => {
        if (a.type !== b.type) return a.type === 'income' ? -1 : 1;
        return a.displayOrder - b.displayOrder;
      });

      const html = sorted.map(cat => {
        const displayName = cat.icon ? `${cat.icon} ${cat.name}` : cat.name;
        return `
        <div class="settings-item">
          <span class="settings-item-name">${displayName} <span style="color: var(--gray-500); font-size: 12px;">(${cat.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ'})</span></span>
          <div class="settings-item-actions">
            <button class="icon-btn" onclick="moveItem('categories', '${cat.id}', -1)">â†‘</button>
            <button class="icon-btn" onclick="moveItem('categories', '${cat.id}', 1)">â†“</button>
            <button class="icon-btn" onclick="toggleFavorite('categories', '${cat.id}')">${cat.isFavorite ? 'â­' : 'â˜†'}</button>
            <button class="icon-btn" onclick="editItem('categories', '${cat.id}')">âœï¸</button>
            <button class="icon-btn" onclick="deleteItem('categories', '${cat.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>
      `;
      }).join('');
      document.getElementById('categoriesList').innerHTML = html;
    }

    // ============================================
    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    // ============================================
    function selectItem(containerId, itemId) {
      if (containerId === 'userSelect') {
        state.selectedUser = itemId;
      } else if (containerId === 'categorySelect') {
        state.selectedCategory = itemId;
      } else if (containerId === 'paymentMethodSelect') {
        state.selectedPaymentMethod = itemId;
      } else if (containerId === 'assetSelect') {
        state.selectedAsset = itemId;
      } else if (containerId === 'fromAssetSelect') {
        state.selectedFromAsset = itemId;
      } else if (containerId === 'toAssetSelect') {
        state.selectedToAsset = itemId;
      }

      // ì„ íƒëœ í•­ëª©ë§Œ ì‹œê°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
      const container = document.getElementById(containerId);
      container.querySelectorAll('.select-item').forEach(el => {
        el.classList.remove('selected');
      });
      event.target.classList.add('selected');
    }

    function toggleExpand(containerId) {
      state.expandedSections[containerId] = !state.expandedSections[containerId];

      if (containerId === 'categorySelect') {
        const categories = state.categories
          .filter(c => c.type === state.selectedType)
          .sort((a, b) => a.displayOrder - b.displayOrder);
        renderSelectGrid('categorySelect', categories, state.selectedCategory, null, true);
      } else if (containerId === 'paymentMethodSelect') {
        const methods = [...state.paymentMethods].sort((a, b) => a.displayOrder - b.displayOrder);
        renderSelectGrid('paymentMethodSelect', methods, state.selectedPaymentMethod, null, true);
      }
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function openTransactionModal() {
      // ì´ˆê¸°í™”
      state.selectedUser = null;
      state.selectedType = 'expense';
      state.selectedCategory = null;
      state.selectedPaymentMethod = null;
      state.selectedAsset = null;

      document.getElementById('amountInput').value = '';
      document.getElementById('memoInput').value = '';

      // ì„ íƒëœ ë‚ ì§œë¡œ ì„¤ì • (ì—†ìœ¼ë©´ ì˜¤ëŠ˜)
      document.getElementById('dateInput').value = state.selectedDate || formatDate(new Date());

      // ì‚¬ìš©ì ì„ íƒ ë Œë”ë§
      renderSelectGrid('userSelect', state.users, null);

      // íƒ€ì… ì„ íƒ
      document.querySelectorAll('#transactionModal .select-item[data-type]').forEach(el => {
        el.classList.remove('selected');
        if (el.dataset.type === 'expense') el.classList.add('selected');
        el.onclick = () => {
          state.selectedType = el.dataset.type;
          document.querySelectorAll('#transactionModal .select-item[data-type]').forEach(e => e.classList.remove('selected'));
          el.classList.add('selected');

          // ì¹´í…Œê³ ë¦¬ ë‹¤ì‹œ ë Œë”ë§
          const categories = state.categories
            .filter(c => c.type === state.selectedType)
            .sort((a, b) => a.displayOrder - b.displayOrder);
          state.selectedCategory = null;
          renderSelectGrid('categorySelect', categories, null, null, true);
        };
      });

      // ì¹´í…Œê³ ë¦¬ ë Œë”ë§
      const categories = state.categories
        .filter(c => c.type === 'expense')
        .sort((a, b) => a.displayOrder - b.displayOrder);
      renderSelectGrid('categorySelect', categories, null, null, true);

      // ê²°ì œìˆ˜ë‹¨ ë Œë”ë§
      const methods = [...state.paymentMethods].sort((a, b) => a.displayOrder - b.displayOrder);
      renderSelectGrid('paymentMethodSelect', methods, null, null, true);

      // ìì‚° ë Œë”ë§
      const assets = [...state.assets].sort((a, b) => a.displayOrder - b.displayOrder);
      renderSelectGrid('assetSelect', assets, null, null, false);

      // ëª¨ë‹¬ ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ
      const modal = document.getElementById('transactionModalContent');
      modal.scrollTop = 0;

      openModal('transactionModal');
    }

    function saveTransaction() {
      const amount = parseFormattedNumber(document.getElementById('amountInput').value);
      const date = document.getElementById('dateInput').value;
      const memo = document.getElementById('memoInput').value;

      if (!state.selectedUser || !amount || !date || !state.selectedCategory || !state.selectedPaymentMethod || !state.selectedAsset) {
        alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      const transaction = {
        id: generateId(),
        type: state.selectedType,
        userId: state.selectedUser,
        amount: amount,
        categoryId: state.selectedCategory,
        paymentMethodId: state.selectedPaymentMethod,
        assetId: state.selectedAsset,
        toAssetId: null,
        memo: memo,
        transactionDate: date,
        createdAt: new Date().toISOString()
      };

      state.transactions.push(transaction);
      saveData();
      closeModal('transactionModal');

      // ëª¨ë‹¬ ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ
      const modal = document.getElementById('transactionModalContent');
      modal.scrollTop = 0;

      renderAll();
      renderSelectedDateTransactions(state.selectedDate);
    }

    function openTransferModal() {
      state.selectedFromAsset = null;
      state.selectedToAsset = null;

      document.getElementById('transferAmountInput').value = '';
      document.getElementById('transferDateInput').value = formatDate(new Date());

      const assets = [...state.assets].sort((a, b) => a.displayOrder - b.displayOrder);
      renderSelectGrid('fromAssetSelect', assets, null);
      renderSelectGrid('toAssetSelect', assets, null);

      openModal('transferModal');
    }

    function saveTransfer() {
      const amount = parseFormattedNumber(document.getElementById('transferAmountInput').value);
      const date = document.getElementById('transferDateInput').value;

      if (!state.selectedFromAsset || !state.selectedToAsset || !amount || !date) {
        alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      if (state.selectedFromAsset === state.selectedToAsset) {
        alert('ê°™ì€ ìì‚°ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      const transaction = {
        id: generateId(),
        type: 'transfer',
        userId: null,
        amount: amount,
        categoryId: null,
        paymentMethodId: null,
        assetId: state.selectedFromAsset,
        toAssetId: state.selectedToAsset,
        memo: '',
        transactionDate: date,
        createdAt: new Date().toISOString()
      };

      state.transactions.push(transaction);
      saveData();
      closeModal('transferModal');
      renderAll();
    }

    function moveItem(collection, itemId, direction) {
      const items = state[collection];
      const index = items.findIndex(i => i.id === itemId);
      if (index === -1) return;

      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= items.length) return;

      // displayOrder êµí™˜
      const temp = items[index].displayOrder;
      items[index].displayOrder = items[newIndex].displayOrder;
      items[newIndex].displayOrder = temp;

      // ë°°ì—´ ì¬ì •ë ¬
      items.sort((a, b) => a.displayOrder - b.displayOrder);

      saveData();
      if (collection === 'paymentMethods') renderPaymentMethodsSettings();
      else if (collection === 'assets') renderAssetsSettings();
      else if (collection === 'categories') renderCategoriesSettings();
    }

    function toggleFavorite(collection, itemId) {
      const item = state[collection].find(i => i.id === itemId);
      if (item) {
        item.isFavorite = !item.isFavorite;
        saveData();
        if (collection === 'paymentMethods') renderPaymentMethodsSettings();
        else if (collection === 'assets') renderAssetsSettings();
        else if (collection === 'categories') renderCategoriesSettings();
      }
    }

    function editItem(collection, itemId) {
      const item = state[collection].find(i => i.id === itemId);
      if (!item) return;

      const newName = prompt(`${item.name}ì˜ ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:`, item.name);
      if (newName && newName.trim()) {
        item.name = newName.trim();
        saveData();
        if (collection === 'paymentMethods') renderPaymentMethodsSettings();
        else if (collection === 'assets') renderAssetsSettings();
        else if (collection === 'categories') renderCategoriesSettings();
      }
    }

    function deleteItem(collection, itemId) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const index = state[collection].findIndex(i => i.id === itemId);
      if (index !== -1) {
        state[collection].splice(index, 1);
        saveData();
        if (collection === 'paymentMethods') renderPaymentMethodsSettings();
        else if (collection === 'assets') renderAssetsSettings();
        else if (collection === 'categories') renderCategoriesSettings();
      }
    }

    function addNewItem(collection, type = null) {
      const name = prompt('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
      if (!name || !name.trim()) return;

      const maxOrder = Math.max(0, ...state[collection].map(i => i.displayOrder));
      const newItem = {
        id: generateId(),
        name: name.trim(),
        displayOrder: maxOrder + 1,
        isFavorite: false
      };

      if (collection === 'categories') {
        newItem.type = type || 'expense';
      }

      if (collection === 'assets') {
        newItem.balance = 0;
      }

      state[collection].push(newItem);
      saveData();

      if (collection === 'paymentMethods') renderPaymentMethodsSettings();
      else if (collection === 'assets') renderAssetsSettings();
      else if (collection === 'categories') renderCategoriesSettings();
    }

    function renderAll() {
      updateMonthDisplay();
      updateSummary();
      renderCalendar();
      renderTransactionList();
      renderAssetsList();
      renderStats();
    }

    // ============================================
    // ì´ˆê¸°í™”
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Supabase ìë™ ì—°ê²°
      const defaultSupabaseUrl = 'https://zmnzfeicabvquwbxgjwt.supabase.co';
      const defaultSupabaseKey = 'sb_publishable_EUBiU6pKPHdimu-roGXrag_CK9rWVdm';

      if (defaultSupabaseUrl && defaultSupabaseKey && typeof supabase !== 'undefined') {
        try {
          state.supabaseClient = supabase.createClient(defaultSupabaseUrl, defaultSupabaseKey);
          state.useLocalStorage = false;
          document.getElementById('connectionStatus').textContent = 'Supabase ì—°ê²°ë¨ (ìë™ ë™ê¸°í™”)';
          document.getElementById('connectionStatus').className = 'connection-status connected';
          document.getElementById('syncData').style.display = 'block';
          document.getElementById('autoSyncInfo').style.display = 'block';
          console.log('âœ… Supabase ìë™ ì—°ê²° ì™„ë£Œ');
        } catch (error) {
          console.error('Supabase ìë™ ì—°ê²° ì‹¤íŒ¨:', error);
        }
      }

      // ì•± ì‹œì‘ ì‹œ ë°ì´í„° ë¡œë“œ
      await loadData();
      renderAll();
      renderPaymentMethodsSettings();
      renderAssetsSettings();
      renderCategoriesSettings();

      // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”í•˜ê³  ê±°ë˜ ë‚´ì—­ í‘œì‹œ
      state.selectedDate = formatDate(new Date());
      renderSelectedDateTransactions(state.selectedDate);

      // ê¸ˆì•¡ ì…ë ¥ í•„ë“œì— ì‹¤ì‹œê°„ ì‰¼í‘œ ì¶”ê°€
      const amountInput = document.getElementById('amountInput');
      amountInput.addEventListener('input', (e) => {
        const cursorPosition = e.target.selectionStart;
        const oldValue = e.target.value;
        const oldLength = oldValue.length;

        const formatted = formatNumber(e.target.value);
        e.target.value = formatted;

        // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
        const newLength = formatted.length;
        const diff = newLength - oldLength;
        e.target.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
      });

      // ìì‚° ì´ë™ ê¸ˆì•¡ ì…ë ¥ í•„ë“œì—ë„ ì‹¤ì‹œê°„ ì‰¼í‘œ ì¶”ê°€
      const transferAmountInput = document.getElementById('transferAmountInput');
      transferAmountInput.addEventListener('input', (e) => {
        const cursorPosition = e.target.selectionStart;
        const oldValue = e.target.value;
        const oldLength = oldValue.length;

        const formatted = formatNumber(e.target.value);
        e.target.value = formatted;

        const newLength = formatted.length;
        const diff = newLength - oldLength;
        e.target.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
      });

      // ê¸ˆì•¡ ì´ˆê¸°í™” ë²„íŠ¼
      document.getElementById('resetAmountBtn').addEventListener('click', () => {
        document.getElementById('amountInput').value = '';
      });

      document.getElementById('resetTransferAmountBtn').addEventListener('click', () => {
        document.getElementById('transferAmountInput').value = '';
      });

      // í•˜ë‹¨ íƒ­ ì „í™˜
      document.querySelectorAll('.nav-item').forEach(navItem => {
        navItem.addEventListener('click', () => {
          document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

          navItem.classList.add('active');
          document.getElementById(navItem.dataset.tab + '-content').classList.add('active');

          if (navItem.dataset.tab === 'stats') {
            renderStats();
          } else if (navItem.dataset.tab === 'assets') {
            renderAssetsList();
          } else if (navItem.dataset.tab === 'calendar') {
            renderCalendar();
            renderSelectedDateTransactions(state.selectedDate);
          }
        });
      });

      // ì›” ë³€ê²½
      document.getElementById('prevMonth').addEventListener('click', () => {
        state.currentDate.setMonth(state.currentDate.getMonth() - 1);
        renderAll();
        renderSelectedDateTransactions(state.selectedDate);
      });

      document.getElementById('nextMonth').addEventListener('click', () => {
        state.currentDate.setMonth(state.currentDate.getMonth() + 1);
        renderAll();
        renderSelectedDateTransactions(state.selectedDate);
      });

      // ê±°ë˜ ì¶”ê°€
      document.getElementById('addTransactionBtn').addEventListener('click', openTransactionModal);
      document.getElementById('saveTransaction').addEventListener('click', saveTransaction);

      // ìì‚° ì´ë™
      document.getElementById('transferAssetBtn').addEventListener('click', openTransferModal);
      document.getElementById('saveTransfer').addEventListener('click', saveTransfer);

      // ê¸ˆì•¡ ë¹ ë¥¸ ì…ë ¥
      document.querySelectorAll('.quick-amount-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const amount = parseInt(btn.dataset.amount);
          const target = btn.dataset.target;

          if (target === 'transfer') {
            const input = document.getElementById('transferAmountInput');
            const currentAmount = parseFormattedNumber(input.value) || 0;
            input.value = formatNumber(currentAmount + amount);
          } else {
            const input = document.getElementById('amountInput');
            const currentAmount = parseFormattedNumber(input.value) || 0;
            input.value = formatNumber(currentAmount + amount);
          }
        });
      });

      // í•„í„°
      document.querySelectorAll('#logFilters .filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#logFilters .filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.logFilter = btn.dataset.filter;
          renderTransactionList();
        });
      });

      // í†µê³„ ê¸°ê°„ í•„í„°
      document.querySelectorAll('#stats-content .filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#stats-content .filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.statsFilter = btn.dataset.period;
          renderStats();
        });
      });

      // ê²€ìƒ‰
      document.getElementById('searchInput').addEventListener('input', (e) => {
        state.searchQuery = e.target.value;
        renderTransactionList();
      });

      // ì˜ˆì‚° ì €ì¥
      document.getElementById('saveBudget').addEventListener('click', () => {
        const budgetInput = document.getElementById('monthlyBudgetInput');
        state.monthlyBudget = parseInt(budgetInput.value) || 0;
        saveData();
        updateSummary();
        alert('ì˜ˆì‚°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      });

      // ì„¤ì • íƒ­ ì—´ë¦´ ë•Œ ì˜ˆì‚° ì…ë ¥ê°’ ì—…ë°ì´íŠ¸
      document.querySelector('[data-tab="settings"]').addEventListener('click', () => {
        document.getElementById('monthlyBudgetInput').value = state.monthlyBudget || '';
      });

      // ì„¤ì •
      document.getElementById('useLocal').addEventListener('click', () => {
        state.useLocalStorage = true;
        state.supabaseClient = null;
        document.getElementById('connectionStatus').textContent = 'ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš© ì¤‘';
        document.getElementById('connectionStatus').className = 'connection-status local';
        document.getElementById('syncData').style.display = 'none';
        saveData();
      });

      // Supabase ìˆ˜ë™ ë™ê¸°í™” ë²„íŠ¼
      document.getElementById('syncData').addEventListener('click', async () => {
        if (!state.supabaseClient) {
          alert('Supabaseì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          return;
        }

        console.log('ğŸ”„ ìˆ˜ë™ ë™ê¸°í™” ì‹œì‘...');
        console.log('í˜„ì¬ ê±°ë˜ ìˆ˜:', state.transactions.length);

        const syncBtn = document.getElementById('syncData');
        syncBtn.textContent = 'ğŸ”„ ë™ê¸°í™” ì¤‘...';
        syncBtn.disabled = true;

        try {
          // Supabaseì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          console.log('ğŸ“¥ Supabaseì—ì„œ ìµœì‹  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
          await loadFromSupabase();
          console.log('âœ… ë¡œë“œ ì™„ë£Œ');
          console.log('ë™ê¸°í™” í›„ ê±°ë˜ ìˆ˜:', state.transactions.length);

          // í™”ë©´ ê°±ì‹ 
          renderAll();
          renderPaymentMethodsSettings();
          renderAssetsSettings();
          renderCategoriesSettings();

          alert('ë°ì´í„° ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
          console.error('âŒ ë™ê¸°í™” ì‹¤íŒ¨:', error);
          alert('ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        } finally {
          syncBtn.textContent = 'ğŸ”„ ìˆ˜ë™ ë™ê¸°í™”';
          syncBtn.disabled = false;
        }
      });

      // Supabase ì—°ê²°
      document.getElementById('connectSupabase').addEventListener('click', async () => {
        const url = document.getElementById('supabaseUrl').value.trim();
        const key = document.getElementById('supabaseKey').value.trim();

        if (!url || !key) {
          alert('Supabase URLê³¼ Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        try {
          // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± (CDN ì‚¬ìš© ê°€ì •)
          if (typeof supabase === 'undefined') {
            alert('Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            return;
          }

          state.supabaseClient = supabase.createClient(url, key);
          state.useLocalStorage = false;

          document.getElementById('connectionStatus').textContent = 'Supabase ì—°ê²°ë¨ (ìë™ ë™ê¸°í™”)';
          document.getElementById('connectionStatus').className = 'connection-status connected';
          document.getElementById('syncData').style.display = 'block';
          document.getElementById('autoSyncInfo').style.display = 'block';

          // ì—°ê²° í›„ ìµœì‹  ë°ì´í„° ìë™ ë¡œë“œ
          await loadFromSupabase();
          renderAll();
          renderPaymentMethodsSettings();
          renderAssetsSettings();
          renderCategoriesSettings();

          alert('Supabaseì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nìë™ ë™ê¸°í™” í™œì„±í™”:\n- ë°ì´í„° ë³€ê²½ ì‹œ 5ì´ˆ í›„ ìë™ ì €ì¥\n- ì•±ì„ ì—´ ë•Œ ìë™ ë¡œë“œ\n- íƒ­ ì „í™˜ ì‹œ ìë™ ë¡œë“œ\n\n"ìˆ˜ë™ ë™ê¸°í™”" ë²„íŠ¼ìœ¼ë¡œ ì¦‰ì‹œ ë™ê¸°í™”ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        } catch (error) {
          console.error('Supabase ì—°ê²° ì‹¤íŒ¨:', error);
          alert('Supabase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      });

      document.getElementById('addPaymentMethod').addEventListener('click', () => addNewItem('paymentMethods'));
      document.getElementById('addAsset').addEventListener('click', () => addNewItem('assets'));
      document.getElementById('addCategory').addEventListener('click', () => {
        const type = confirm('ìˆ˜ì… ì¹´í…Œê³ ë¦¬ì…ë‹ˆê¹Œ? (ì·¨ì†Œí•˜ë©´ ì§€ì¶œ)') ? 'income' : 'expense';
        addNewItem('categories', type);
      });

      // ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('active');
          }
        });
      });
    });

    // ============================================
    // íƒ­ í¬ì»¤ìŠ¤ ì‹œ ìë™ ë™ê¸°í™”
    // ============================================
    document.addEventListener('visibilitychange', async () => {
      // íƒ­ì´ í™œì„±í™”ë˜ê³  Supabase ì—°ê²°ëœ ê²½ìš° ìë™ ë™ê¸°í™”
      if (!document.hidden && !state.useLocalStorage && state.supabaseClient) {
        console.log('íƒ­ í¬ì»¤ìŠ¤ ê°ì§€: ìë™ ë™ê¸°í™” ì‹œì‘');
        await loadFromSupabase();
        renderAll();
        renderPaymentMethodsSettings();
        renderAssetsSettings();
        renderCategoriesSettings();
      }
    });

    // ============================================
    // Service Worker ë“±ë¡ (PWA)
    // ============================================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('Service Worker registered successfully:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>
